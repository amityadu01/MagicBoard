var inheritsFrom=function(e,t){e.prototype=Object.create(t.prototype)},MagicBoard={sheetBook:null,indicators:{mouseDown:!1,mouseover:[],click:!1,doubleClick:0,resize:-1},boardPos:{x:0,y:0}};MagicBoard.properties={"background-color":{propType:"attribute",propName:"fill",label:"Background Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"border-color":{propName:"stroke",propType:"attribute",label:"Border Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"border-width":{propName:"stroke-width",propType:"attribute",label:"Border Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"border-style":{propName:"stroke-dasharray",propType:"attribute",label:"Border Style",field:"select",values:[{name:"Dash",value:"5,5",type:""},{name:"Solid",value:"",type:""},{name:"Dotted",value:"1,1",type:""}]},"text-color":{propName:"fill",propType:"attribute",label:"Text Color",field:"input",values:[{name:"",value:"#ffffff",type:"color"}]},"font-size":{propName:"font-size",propType:"attribute",label:"Font Color",field:"input",values:[{name:"",value:"14",type:"text"}]},"font-weight":{propName:"font-weight",propType:"attribute",label:"Font Weight",field:"select",values:[{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"}]},"text-content":{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{value:""}]},"line-type":{propName:"",propType:"function",field:"select",label:"Line Type",values:[{name:"Straight",value:"straight"},{name:"Zig Zag",value:"zig-zag"},{name:"Brezier Curve",value:"brezier"},{name:"Quadratic Curve",value:"quadratic"}]},"line-color":{propName:"stroke",propType:"attribute",label:"Line Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"line-width":{propName:"stroke-width",propType:"attribute",label:"Line Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"line-style":{propName:"stroke-dasharray",propType:"attribute",label:"Line Style",field:"select",values:[{name:"Solid",value:"",type:""},{name:"Dash",value:"5,5",type:""},{name:"Dotted",value:"1,1",type:""}]},"end-marker":{propName:"marker-end",propType:"attribute",label:"End Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowE)"},{name:"Hollow Arrow",value:"url(#hollowArrowE)"},{name:"Regular Arrow",value:"url(#lineArrowE)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"start-marker":{propName:"marker-start",propType:"attribute",label:"Start Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowS)"},{name:"Hollow Arrow",value:"url(#hollowArrowS)"},{name:"Regular Arrow",value:"url(#lineArrowS)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"mid-marker":{propName:"marker-mid",propType:"attribute",field:"select",label:"Mid Marker",values:[{name:"Dot",value:"url(#dot)"}]}};var SheetBook=function(e,t,i){this.cheight=400,this.cwidth=400,this.sheets=[],this.currentSheet=null,this.anchor=document.body,this.alignments={x:[],y:[]},this.maxRedo=5,this.garbage=document.createElement("div"),this.garbage.setAttribute("style","display:none"),document.body.appendChild(this.garbage),i&&(this.cheight=i),t&&(this.cwidth=t),e&&(this.anchor=e);var o=e.getBoundingClientRect();MagicBoard.boardPos={x:o.left,y:o.top},Utility.SheetBook.createWorkItems(this),document.onmousedown=function(e){return MagicBoard.eventStart(e)},document.onmousemove=function(e){MagicBoard.eventContinue(e)},document.onmouseup=function(e){MagicBoard.eventStop(e)},document.onkeyup=function(e){event.preventDefault(),MagicBoard.keyUp(e)}};SheetBook.prototype.zoom=function(){},SheetBook.prototype.setAnchorElement=function(e){this.anchor=e},SheetBook.prototype.addSheet=function(e){this.sheets.push(e);var t=e.getCanvas();t.setAttribute("height",this.cheight),t.setAttribute("width",this.cwidth),t.style.width=this.cwidth+"px",t.style.height=this.cheight+"px",this.anchor.appendChild(t),this.setCurrentSheet(e)},SheetBook.prototype.getSheet=function(e){for(var t=this.sheets.length-1;t>-1;t--){var i=this.sheets[t];if(i.name===e)return i}return null},SheetBook.prototype.getCurrentSheet=function(){return this.currentSheet},SheetBook.prototype.setCurrentSheet=function(e){var t=this.currentSheet;t&&(t.canvas.style.visibility="hidden");var i=null,o=!1;"string"==typeof e&&(i=e,o=!0);for(var r=this.sheets.length-1;r>-1;r--){var a=this.sheets[r];if(o){if(a.name===i)break}else if(a===e)break}this.currentSheet=e,e.canvas.style.visibility="visible";var n=this.connectCanvas;MagicBoard.sheetBook.connectCtx.clearRect(0,0,n.width,n.height)},SheetBook.prototype.getCombinedImage=function(){var e=this.scratchCtx;if(e){e.clearRect(0,0,this.cwidth,this.cheight);for(var t=this.shapes.length,i=0;t>i;i++){var o=this.shapes[i];o.draw(e)}var r=this.scratchCanvas.toDataURL();return r}},SheetBook.prototype.setHeight=function(e){this.cheight=e,this.currentCanvas.setAttribute("height",this.cheight)},SheetBook.prototype.setWidth=function(e){this.cwidth=e,this.currentCanvas.setAttribute("width",e)};var Sheet=function(e){this.options={},e&&(this.options=e),this.name="Sheet1",e.name&&(this.name=e.name),this.canvas=null,this.init()};Sheet.prototype.init=function(){this.removedShapes=[],this.canvas=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.canvas.setAttribute("id",this.name),this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px",this.canvas.style["z-index"]="1",this.canvas.style.visibility="visible";var e=this.options["background-color"];e&&(this.canvas.style.fill=e),this.connections=[],Utility.Sheet.Markers(this),this.courseGridSize={x:100,y:100},this.noOfXcourseGrids=Math.floor(MagicBoard.sheetBook.cwidth/this.courseGridSize.x),this.noOfYcourseGrids=Math.floor(MagicBoard.sheetBook.cheight/this.courseGridSize.y),this.courseGrids=[];for(var t=0,i=0;i<this.noOfYcourseGrids;i++)for(var o=i*this.courseGridSize.y,r=(i+1)*this.courseGridSize.y,a=0;a<this.noOfXcourseGrids;a++){var n=a*this.courseGridSize.x,s=(a+1)*this.courseGridSize.x,h={filled:!1,shapes:[],x1:n,x2:s,y1:o,y2:r,index:t++};this.courseGrids.push(h)}if(MagicBoard.sheetBook.currentSheet=this,this.shapes=[],this.options.shapes)for(var l=0,c=this.options.shapes.length;c>l;l++){var d=new Shape(this.options.shapes[l]);d.draw(),d.addHover()}},Sheet.prototype.getCanvas=function(){return this.canvas},Sheet.prototype.wipe=function(){for(var e=MagicBoard.sheetBook.garbage,t=this.canvas.children,i=t.length-1;i>-1;i--){var o=t[i];"workItem"!==o.getAttribute("name")&&e.appendChild(o)}e.innerHTML=""},Sheet.prototype.totalShapeArea=function(){},Sheet.prototype.addShape=function(e){this.shapes.push(e)},Sheet.prototype.removeLastShape=function(){var e=MagicBoard.sheetBook.maxRedo;if(0!==this.shapes.length){var t=this.shapes[this.shapes.length-1];this.removedShapes.push(t),this.removedShapes.length>e&&this.removedShapes.splice(0,1),this.shapes.pop()}},Sheet.prototype.removeShape=function(e){if(0!==this.shapes.length)for(var t=this.shapes.length-1;t>-1;t--){var i=this.shapes[t];if(i===e)return void this.shapes.splice(t,1)}},Sheet.prototype.reDraw=function(){this.wipe();for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.createCanvas(),i.draw()}},Sheet.prototype.undo=function(){this.removeLastShape(),this.reDraw()},Sheet.prototype.redo=function(){0!==this.removedShapes.length&&(this.shapes.push(this.removedShapes[0]),this.removedShapes.splice(0,1),this.reDraw())},Sheet.prototype.refreshConnections=function(){for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.refreshConnection()}},Sheet.prototype.getImage=function(){var e=document.createElement("canvas");e.height=MagicBoard.sheetBook.cheight,e.width=MagicBoard.sheetBook.cwidth;for(var t=e.getContext("2d"),i=this.shapes,o=i.length,r=0;o>r;r++){var a=i[r];a.drawOnCanvas(t)}var n=e.toDataURL();return n},Sheet.prototype.addConnections=function(e){for(var t=e.beginShape,i=e.endShape,o=e.pos,r=this.connections,a=r.length,n=!1,s=0;a>s;s++){var h=r[s],o=e.pos;if(h.beginShape===t&&h.endShape===i)return n=!0,h.pos=o,h.orientation=e.orientation,h}return n||r.push(e),e},Sheet.prototype.save=function(){var e={};e.options=this.options,e.shapes=[];for(var t=0,i=this.shapes.length;i>t;t++){var o=this.shapes[t],r=o.save();r&&e.shapes.push(r)}return e},Sheet.prototype.removeConnections=function(e){for(var t=e.connectedFrom,i=(t.length,0);a>i;i++){var o=t[i];Utility.Sheet.removeConnection(this,o,e)}for(var r=e.connectedTo,a=r.length,n=0;a>n;n++){var s=r[n];Utility.Sheet.removeConnection(this,e,s)}},Sheet.prototype.drawConnections=function(e){if(!e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height)}for(var o=this.connections,r=o.length,a=0;r>a;a++){var n=o[a];n.shape&&(n.shape.deleteShape(),n.shape=null);var s=new ConnectorLine(n);s.draw()}};var Point=function(e,t){this.x=e,this.y=t},DrawingObject=function(){this.draw=function(){}},Shape=function(e){this.param=JSON.parse(JSON.stringify(e.param)),this.frame=JSON.parse(JSON.stringify(e.frame)),e.connectedFromIds&&(this.connectedFromIds=e.connectedFromIds),e.connectedToIds&&(this.connectedToIds=e.connectedToIds),e.id&&(this.id=e.id),this.properties={},this.components=[];for(var t=e.componentParms.length,i=0;t>i;i++){var o=new ShapeComponent(e.componentParms[i]);this.components.push(o);for(var r in o.properties)this.properties[r]=!0}this.init()};inheritsFrom(Shape,DrawingObject),Shape.prototype.init=function(){this.children||(this.children=[]),this.components||(this.components=[]),this.param.alignmentRails||(this.param.alignmentRails=!0),this.occupiedGrids=[],this.currentSheet=MagicBoard.sheetBook.getCurrentSheet(),this.sheetCanvas=this.currentSheet.getCanvas(),this.frame&&this.createCanvas();this.dimension=this.frame,this.id||(this.id=this.currentSheet.shapes.length),this.currentSheet.addShape(this),this.connectedTo=[],this.connectedFrom=[]},Shape.prototype.createCanvas=function(){var e=Utility.Shape.dataFormatter(this.frame.width,"width",this);this.frame.width=e;var t=Utility.Shape.dataFormatter(this.frame.height,"height",this);this.frame.height=t;var i=document.createElementNS("http://www.w3.org/2000/svg","g");this.dom=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("width",e),this.dom.setAttribute("height",t),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("style","position:absolute;-ms-user-select:none;-webkit-user-select:none;z-index:10;transform:translate(1.5,1.5);z-index:1"),this.dom.setAttribute("x",Utility.Shape.dataFormatter(this.frame.left,"left",this)),this.dom.setAttribute("y",Utility.Shape.dataFormatter(this.frame.top,"top",this)),i.appendChild(this.dom),this.sheetCanvas.appendChild(i)},Shape.prototype.addComponent=function(e){this.components.push(e)},Shape.prototype.addHover=function(){var e=this,t=this.dom;t.onmouseover=function(){MagicBoard.indicators.mouseover.push(e)},t.onmouseout=function(){event.preventDefault();for(var t=MagicBoard.indicators.mouseover.length-1;t>-1;t--)if(MagicBoard.indicators.mouseover[t]===e)return void MagicBoard.indicators.mouseover.splice(t,1)}},Shape.prototype.click=function(){this.selectToggle()},Shape.prototype.doubleClick=function(){var e=this,t=event.target;if(t instanceof SVGTextElement){var i=t.getBoundingClientRect(),o=MagicBoard.sheetBook.textEditor;o.style.left=i.left-2,o.style.top=i.top-2,o.style.width=i.width+4,o.style.height=i.height+4,o.style.display="block",o.innerHTML=t.innerHTML,o.targetShape=e,o.focus()}},Shape.prototype.move=function(e,t){var i=this.getDimension(),o=e.y-t.y,r=e.x-t.x,a=i.top+o,n=i.bottom+o,s=i.left+r,h=i.right+r,l=MagicBoard.sheetBook.scratchCtx,c=MagicBoard.sheetBook.scratchCanvas;l.clearRect(0,0,c.width,c.height),l.beginPath(),l.strokeStyle="green",l.setLineDash([2,2]),l.lineWidth=4,l.rect(s-2,a-2,i.width+4,i.height+4),l.stroke(),this.alignmentCheck(l,c.width,c.height,a,s,n,h)},Shape.prototype.resizeContinue=function(e,t){var i=(this.getDimension(),MagicBoard.sheetBook.hilighter);if(MagicBoard.indicators.resize<2){var o=this.dimension.width,r=e.x-t.x,a=o;a=0===MagicBoard.indicators.resize?o-r:o+r;var n=a/o,s="translateX("+r/2+"px) scaleX("+n+")";this.dom.style.transform=s,i.style.transform=s}else if(MagicBoard.indicators.resize>1){var h=this.dimension.height,l=e.y-t.y,c=h;c=2===MagicBoard.indicators.resize?h-l:h+l;var n=c/h,s="translateY("+l/2+"px) scaleY("+n+")";this.dom.style.transform=s,i.style.transform=s}},Shape.prototype.resizeStop=function(){var e=MagicBoard.indicators.resizeStarted,t=MagicBoard.indicators.click,i={x:this.dimension.left,y:this.dimension.top},o=MagicBoard.sheetBook.hilighter;if(o.style.visibility="hidden",o.style.transform="",this.dom.style.transform="",MagicBoard.indicators.resize<2){var r=this.dimension.width,a=e.x-t.x,n=r;0===MagicBoard.indicators.resize?(n=r-a,i.x=e.x):n=r+a,this.dimension.width=n,this.dom.setAttribute("width",n)}else{var s=this.dimension.height,h=e.y-t.y,l=s;2===MagicBoard.indicators.resize?(l=s-h,i.y=e.y):l=s+h,this.dimension.height=l,this.dom.setAttribute("height",l)}this.setPosition(i),this.reDraw(),MagicBoard.indicators.resize=-1,MagicBoard.indicators.resizeStarted=null,MagicBoard.indicators.hilight=!1},Shape.prototype.lineTo=function(e){var t=this.getDimension(),i=MagicBoard.sheetBook.scratchCtx,o=MagicBoard.sheetBook.scratchCanvas;i.clearRect(0,0,o.width,o.height),i.beginPath(),i.strokeStyle="gray",i.lineWidth=1,i.setLineDash([5,5]),i.moveTo(t.cx,t.cy),i.lineTo(e.x,e.y),i.stroke(),i.setLineDash([5,0]);var r=Drawing.getLineAngle(e.x,e.y,t.left,t.top);Drawing.drawArrow(i,e.x,e.y,r)},Shape.prototype.refreshConnection=function(e){for(var t=this.currentSheet,i=this.connectedFrom,o=i.length,r=0;o>r;r++){var a=i[r],n=Utility.Shape.calculateConnectionPoints(a,this);t.addConnections(n),t.drawConnections(e)}for(var s=this.connectedTo,h=s.length,l=0;h>l;l++){endShape=s[l];var n=Utility.Shape.calculateConnectionPoints(this,endShape);t.addConnections(n),t.drawConnections(e)}},Shape.prototype.connectFrom=function(e){for(var t=this.connectedFrom,i=!1,o=t.length,r=0;o>r;r++){var a=t[r];if(e===a)break}i||this.connectedFrom.push(e)},Shape.prototype.connectTo=function(e){var t=this;this.parentShape&&(t=this.parentShape),e.parentShape&&(e=e.parentShape);for(var i=this.connectedTo,o=!1,r=i.length,a=0;r>a;a++){var n=i[a];if(e===n)break}o||t.connectedTo.push(e),e.connectFrom(t);var s=Utility.Shape.calculateConnectionPoints(t,e),h=MagicBoard.sheetBook.currentSheet;h.addConnections(s),h.drawConnections()},Shape.prototype.alignmentCheck=function(e,t,i,o,r,a,n){e.beginPath(),e.strokeStyle="gray",e.lineWidth=1,e.setLineDash([5,5]),MagicBoard.sheetBook.alignments.x[o]&&(e.moveTo(0,o),e.lineTo(t,o)),MagicBoard.sheetBook.alignments.x[a]&&(e.moveTo(0,a),e.lineTo(t,a)),MagicBoard.sheetBook.alignments.y[r]&&(e.moveTo(r,0),e.lineTo(r,i)),MagicBoard.sheetBook.alignments.y[n]&&(e.moveTo(n,0),e.lineTo(n,i)),e.stroke(),e.setLineDash([5,0])},Shape.prototype.setPosition=function(e,t){this.param.alignmentRails&&this.removeAlignments();var i=this.frame;t?(e=Utility.Shape.align(e),this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y)):(this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y)),i.left=e.x,i.top=e.y,i.right=i.left+i.width,i.bottom=i.top+i.height,i.cx=i.left+i.width/2,i.cy=i.top+i.height/2;var o={c1:{x:i.left,y:i.top},c2:{x:i.right,y:i.top},c3:{x:i.right,y:i.bottom},c4:{x:i.left,y:i.bottom},m12:{x:i.cx,y:i.top},m23:{x:i.right,y:i.cy},m34:{x:i.cx,y:i.bottom},m41:{x:i.left,y:i.cy}};i.edgePoints=o,this.refreshConnection(),this.param.alignmentRails&&this.addAlignments(),this.param.noGridBlock||Utility.Shape.blockGrids(this)},Shape.prototype.setDimension=function(e){this.dimension={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.width,height:e.height},this.addAlignments()},Shape.prototype.removeAlignments=function(){var e=function(e,t){if(!e)return!1;var i=e.length;if(2>i)return!1;for(var o=i-1;o>-1;o--){var r=e[o];if(r===t)return void e.splice(o,1)}},t=this.dimension,i=e(MagicBoard.sheetBook.alignments.y[t.left],this);i||(MagicBoard.sheetBook.alignments.y[t.left]=null),i=e(MagicBoard.sheetBook.alignments.y[t.right],this),i||(MagicBoard.sheetBook.alignments.y[t.right]=null),i=e(MagicBoard.sheetBook.alignments.y[t.cx],this),i||(MagicBoard.sheetBook.alignments.y[t.cx]=null),i=e(MagicBoard.sheetBook.alignments.x[t.top],this),i||(MagicBoard.sheetBook.alignments.x[t.top]=null),i=e(MagicBoard.sheetBook.alignments.x[t.bottom],this),i||(MagicBoard.sheetBook.alignments.x[t.bottom]=null),i=e(MagicBoard.sheetBook.alignments.x[t.cy],this),i||(MagicBoard.sheetBook.alignments.x[t.cy]=null)},Shape.prototype.addAlignments=function(){var e=this.dimension;MagicBoard.sheetBook.alignments.y[e.left]||(MagicBoard.sheetBook.alignments.y[e.left]=[]),MagicBoard.sheetBook.alignments.y[e.left].push(this),MagicBoard.sheetBook.alignments.y[e.right]||(MagicBoard.sheetBook.alignments.y[e.right]=[]),MagicBoard.sheetBook.alignments.y[e.right].push(this),MagicBoard.sheetBook.alignments.y[e.cx]||(MagicBoard.sheetBook.alignments.y[e.cx]=[]),MagicBoard.sheetBook.alignments.y[e.cx].push(this),MagicBoard.sheetBook.alignments.x[e.top]||(MagicBoard.sheetBook.alignments.x[e.top]=[]),MagicBoard.sheetBook.alignments.x[e.top].push(this),MagicBoard.sheetBook.alignments.x[e.bottom]||(MagicBoard.sheetBook.alignments.x[e.bottom]=[]),MagicBoard.sheetBook.alignments.x[e.bottom].push(this),MagicBoard.sheetBook.alignments.x[e.cy]||(MagicBoard.sheetBook.alignments.x[e.cy]=[]),MagicBoard.sheetBook.alignments.x[e.cy].push(this)},Shape.prototype.getDimension=function(){return this.dimension||this.setDimension(this.dom.getBoundingClientRect()),this.dimension},Shape.prototype.applyProperty=function(e,t,i,o){for(var r=0,a=this.components.length;a>r;r++){var n=this.components[r];n.properties[e]&&n.applyProperty(t,i,o)}},Shape.prototype.getDom=function(){return this.dom},Shape.prototype.setPoints=function(e){this.points=e},Shape.prototype.getArea=function(){},Shape.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage;e.appendChild(this.dom),e.innerHTML="";for(var t in this)if("object"==typeof this[t]){if("connectedTo"===t){{this.connectedTo}MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections()}else"connectedFrom"===t&&(MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections());this[t]=null}},Shape.prototype.selectToggle=function(){var e=this.getDimension(),t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height);var o=MagicBoard.sheetBook.hilighter;if(MagicBoard.indicators.hilight)o.style.visibility="hidden",setTimeout(function(){MagicBoard.indicators.hilight=!1},100),this.addAlignments();else{for(var r=e.left,a=e.top,n=this.parentShape;n;)r+=n.dimension.left,a+=n.dimension.top,n=n.parentShape;Utility.SheetBook.activateHilighter({left:r,top:a,width:e.width,height:e.height}),MagicBoard.indicators.hilight=this,this.removeAlignments()}},Shape.prototype.updateText=function(e,t){void 0==t&&(t=0);for(var i=0,o=0,r=this.components.length;r>o;o++){var a=this.components[o];if("text"===a.type){if(i===t){a.updateText(e);break}i++}}},Shape.prototype.save=function(){var e={};for(var t in this)if("cInfo"!==t)if("components"!==t)if("connectedFrom"!==t&&"connectedTo"!==t){var i=this[t].constructor.name;("Number"===i||"String"===i||"Object"===i)&&(e[t]=this[t])}else{e[t+"Ids"]=[];for(var o=this[t].length,r=0;o>r;r++){var a=this[t][r];e[t+"Ids"].push(a.id)}}else{e.componentParms=[];for(var o=this.components.length,r=0;o>r;r++){var n=this.components[r];e.componentParms.push(n.save())}}return e},Shape.prototype.draw=function(){var e=this.dom;e.innerHTML="";var t=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(t),this.reDraw(t);for(var i=this.components.length,o=0;i>o;o++){var r=this.components[o];r.parentShape=this;var a=r.construct();a&&t.appendChild(a)}},Shape.prototype.reDraw=function(e){var t=!0;e||(e=this.dom.firstElementChlid,t=!1);for(var i=this.components.length,o=0;i>o;o++){var r=this.components[o];r.parentShape=this;var a=r.construct();t&&a&&e.appendChild(a)}this.refreshConnection()},Shape.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var o=this.components[i];o.drawOnCanvas(e)}e.stroke(),this.refreshConnection(e)};var ConnectorLine=function(e){var t,i,o=0,r=this,a=e.pos,n=a.x1,s=a.y1,h=n,l=s,c=a.x2,d=a.y2;n>c&&(h=c),s>d&&(l=d),h-=10,l-=10;var p=Math.abs(a.x2-a.x1)+20,m=Math.abs(a.y2-a.y1)+20;this.frame={width:p,height:m,unit:"px",left:h,top:l};var u=(a.x1+a.x2)/2,g=(a.y1+a.y2)/2,v=[],f=[];v.push({op:"M",x:a.x1,y:a.y1}),f.push({op:"M",x:100*(a.x1-h)/p,y:100*(a.y1-l)/m});var y,k,x,B,n,s;this.cInfo=e,"vert"===e.orientation?(v.push({op:"L",x:a.x1,y:g}),v.push({op:"L",x:c,y:g}),t=Drawing.getLineAngle(n,s,n,g),i=Drawing.getLineAngle(c,d,c,g),f.push({op:"L",x:100*(a.x1-h)/p,y:100*(g-l)/m}),f.push({op:"L",x:100*(c-h)/p,y:100*(g-l)/m}),d>a.y1?(d-=o,x=s+o,B=d-o):(d+=o,x=s-o,B=d+o),y=n,k=c):"horizvert"===e.orientation?(v.push({op:"L",x:a.x2,y:a.y1}),t=Drawing.getLineAngle(n,s,a.x2,a.y1),i=Drawing.getLineAngle(c,d,a.x2,a.y1),f.push({op:"L",x:100*(a.x2-h)/p,y:100*(a.y1-l)/m}),d>a.y1?(d-=o,x=s,B=d-o):(d+=o,x=s,B=d+o),c>a.x1?(y=n+o,k=c):(y=n-o,k=c)):(v.push({op:"L",x:u,y:a.y1}),v.push({op:"L",x:u,y:d}),t=Drawing.getLineAngle(n,s,u,a.y1),i=Drawing.getLineAngle(c,d,u,d),f.push({op:"L",x:100*(u-h)/p,y:100*(a.y1-l)/m}),f.push({op:"L",x:100*(u-h)/p,y:100*(d-l)/m}),c>a.x1?(c-=o,y=n+o,k=c-o):(c+=o,y=n-o,k=c+o),x=s,B=d),v.push({op:"L",x:c,y:d}),f.push({op:"L",x:100*(c-h)/p,y:100*(d-l)/m}),this.param={alignmentRails:!1,noGridBlock:!0},this.components=[];var S={type:"path",origDim:{},dimension:{d:f},param:{fill:"none",stroke:"rgb(27,141,17)","stroke-miterlimit":"10","stroke-width":2,cursor:"hand","marker-end":"url(#fillArrowE)"},lines:v,properties:{"line-style":!0,"line-type":!0,"line-color":!0,"start-marker":!0,"end-marker":!0,"mid-marker":!0}};this.cInfo.angleStart=t,this.cInfo.angleEnd=i,e.param&&(S.param=e.param),e.properties&&(S.properties=e.properties);var b=new ShapeComponent(S);this.components.push(b),this.properties=b.properties;var w=b.dom;w.onmouseover=function(){MagicBoard.indicators.mouseover.push(r);var e=MagicBoard.getPos(event),t=MagicBoard.sheetBook.star.style;t.display="block",t.left=e.x-15,t.top=e.y-15,MagicBoard.sheetBook.star.cLine=r},w.onmouseout=function(){event.preventDefault(),setTimeout(function(){MagicBoard.sheetBook.star.style.display="none"},800);for(var e=MagicBoard.indicators.mouseover.length-1;e>-1;e--)if(MagicBoard.indicators.mouseover[e]===r)return void MagicBoard.indicators.mouseover.splice(e,1)},this.cx1=y,this.cx2=k,this.cy1=x,this.cy2=B,this.init(),e.shape=this,e.properties=b.properties,e.param=b.param};inheritsFrom(ConnectorLine,Shape),ConnectorLine.prototype.save=function(){return null},ConnectorLine.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var o=this.components[i];if(o.drawOnCanvas(e),o.param["marker-end"]){var r=o.param["marker-end"];r="url(#fillArrowE)"===r?"Filled":"url(#hollowArrowE)"===r?"Hollow":"url(#hollowDiamond)"===r?"DiamondHollow":"url(#fillDiamond)"===r?"DiamondFilled":"url(#dot)"===r?"Dot":"Regular";var a=o.lines,n=a[a.length-1];Drawing.drawArrow(e,n.x+this.dimension.left,n.y+this.dimension.top,this.cInfo.angleEnd,r,o.param.fill,o.param.stroke)}if(o.param["marker-start"]){var r=o.param["marker-start"];r="url(#fillArrowS)"===r?"Filled":"url(#hollowArrowS)"===r?"Hollow":"url(#hollowDiamond)"===r?"DiamondHollow":"url(#fillDiamond)"===r?"DiamondFilled":"url(#dot)"===r?"Dot":"Regular";var a=o.lines,s=a[0];Drawing.drawArrow(e,s.x+this.dimension.left,s.y+this.dimension.top,this.cInfo.angleStart,r,o.param.fill,o.param.stroke)}}e.stroke()},ConnectorLine.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage;e.appendChild(this.dom),e.innerHTML="";for(var t in this)"object"==typeof this[t]&&(this[t]=null)};var ShapeComponent=function(e){for(var t in e)this[t]=e[t];this.parentShape=null,this.dom=document.createElementNS("http://www.w3.org/2000/svg",this.type);for(var t in this.param)"border-radius"===t?(this.dom.setAttribute("rx",this.param[t]),this.dom.setAttribute("ry",this.param[t])):this.dom.setAttribute(t,this.param[t]);if(this.innerHTML&&(this.dom.innerHTML=this.innerHTML),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("transform","translate(1,1)"),this.derivedDimension={},!this.properties)switch(this.type){case"text":this.properties={"text-color":!0,"font-size":!0,"font-weight":!0,"text-content":!0};break;case"path":this.properties={"background-color":!0,"line-color":!0,"line-width":!0,"line-style":!0};break;default:this.properties={"background-color":!0,"border-color":!0,"border-width":!0,"border-style":!0}}};ShapeComponent.prototype.construct=function(){if(this.parentShape){var e=this.dom;this.calculateDimensions();for(var t in this.derivedDimension)this.dom.setAttribute(t,this.derivedDimension[t]);if("image"===this.type){var i=this.xlink;this.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",i)}return e}},ShapeComponent.prototype.save=function(){var e={};for(var t in this){var i=this[t].constructor.name;("String"===i||"Object"===i)&&(e[t]=this[t])}return e},ShapeComponent.prototype.calculateDimensions=function(){var e=0;this.param["stroke-width"]&&(e=parseInt(this.param["stroke-width"])),pw=this.parentShape.frame.width-2*e,ph=this.parentShape.frame.height-2*e;for(var t in this.dimension){var i="",o=this.dimension[t];switch(t){case"width":i=o*pw/100-2*e;break;case"x":case"x1":case"x2":case"cx":i=o*pw/100+e;break;case"rx":case"r":i=o*pw/100-e;break;case"height":i=o*ph/100-2*e;break;case"y":case"y1":case"y2":case"cy":i=o*ph/100+e;break;case"ry":i=o*ph/100-e;break;case"d":this.lines||(this.lines=[]);for(var r=o,a=r.length,n=0;a>n;n++){var s=r[n];if("Z"===s.op.toUpperCase()){i+=" Z ";break}for(var h in s){var l=s[h];h.indexOf("x")>-1?l=Math.round(s[h]*pw/100):h.indexOf("y")>-1&&(l=Math.round(s[h]*ph/100)),this.lines[n][h]=l,i+=l+" "}}}i&&(this.derivedDimension[t]=i)}if("text"===this.type||"rect"===this.type){if(this.dimension.cx){var c=parseInt(dom.getAttribute("cx"))-parseInt(dom.getAttribute("width"))/2;this.derivedDimension.x=c}if(this.dimension.cy){var d=parseInt(dom.getAttribute("cy"))-parseInt(dom.getAttribute("height"))/2;this.derivedDimension.y=d}}},ShapeComponent.prototype.drawOnCanvas=function(e){var t=this.parentShape.dimension.left,i=this.parentShape.dimension.top,o=0;this.param["stroke-width"]&&(o=parseInt(this.param["stroke-width"]));var r=this.derivedDimension.x+t,a=this.derivedDimension.y+i;r||(r=t),a||(a=i);var n=this.param.fill;"none"===n&&(n="");var s=!1;if(this.param["stroke-dasharray"]){var h=this.param["stroke-dasharray"],l=h.split(",");e.setLineDash(l),s=!0}switch(this.type){case"rect":n?(e.fillStyle=n,e.fillRect(r,a,this.derivedDimension.width,this.derivedDimension.height)):e.strokeRect(r,a,this.derivedDimension.width,this.derivedDimension.height);break;case"circle":break;case"ellipse":var c=this.derivedDimension.cx+t,d=this.derivedDimension.cy+i;Drawing.drawEllipse(e,c,d,this.derivedDimension.rx,this.derivedDimension.ry,n,this.param.stroke);break;case"path":Drawing.drawLines(e,t,i,this.derivedDimension.d,n,this.param.stroke,o);break;case"polyline":break;case"text":n&&(e.fillStyle=n),this.param.stroke&&(e.strokeStyle=this.param.stroke),e.fillText(this.innerHTML,r,a)}s&&e.setLineDash([])},ShapeComponent.prototype.applyProperty=function(e,t,i){"attribute"===t?i?(this.dom.setAttribute(e,i),this.param[e]=i):(this.dom.removeAttribute(e),delete this.param[e]):"dom"===t&&(this.dom.innerHTML=i)},ShapeComponent.prototype.updateText=function(e){this.innerHTML=e,this.dom.innerHTML=e};var Drawing={};Drawing.getLineAngle=function(e,t,i,o){return Math.atan2(t-o,e-i)},Drawing.getArrowHead=function(e,t,i){var o,r,a,n,s=10;return o=e-s*Math.cos(i-Math.PI/6),a=t-s*Math.sin(i-Math.PI/6),r=e-s*Math.cos(i+Math.PI/6),n=t-s*Math.sin(i+Math.PI/6),{x1:o,x2:r,y1:a,y2:n}},Drawing.drawArrow=function(e,t,i,o,r,a,n){r||(r="Regular"),a&&"none"!==a||(a="");var s,h,l,c,d=15;switch(s=t-d*Math.cos(o-Math.PI/6),l=i-d*Math.sin(o-Math.PI/6),h=t-d*Math.cos(o+Math.PI/6),c=i-d*Math.sin(o+Math.PI/6),e.beginPath(),n&&(e.strokeStyle=n),r){case"Regular":e.moveTo(t,i),e.lineTo(s,l),e.moveTo(t,i),e.lineTo(h,c);break;case"Filled":e.moveTo(t,i),e.lineTo(s,l),e.lineTo(h,c),e.lineTo(t,i),!a&&n&&(a=n),e.fillStyle=a,e.fill();break;case"Hollow":e.moveTo(t,i),e.lineTo(s,l),e.lineTo(h,c),e.lineTo(t,i);break;case"DiamondFilled":var p=l+c-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,l),e.lineTo(m,p),e.lineTo(h,c),e.lineTo(t,i),!a&&n&&(a=n),e.fillStyle=a,e.fill();break;case"DiamondHollow":var p=l+c-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,l),e.lineTo(m,p),e.lineTo(h,c),e.lineTo(t,i);break;case"Dot":var u=t-5*Math.cos(o),g=i-5*Math.sin(o),v=5;e.arc(u,g,v,0,2*Math.PI),!a&&n&&(a=n),e.fillStyle=a,e.fill()}return e.stroke(),{x1:s,x2:h,y1:l,y2:c}},Drawing.roundRect=function(e,t,i,o,r,a,n,s){if("undefined"==typeof s&&(s=!0),"undefined"==typeof a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var h={tl:0,tr:0,br:0,bl:0};for(var l in h)a[l]=a[l]||h[l]}e.beginPath(),e.moveTo(t+a.tl,i),e.lineTo(t+o-a.tr,i),e.quadraticCurveTo(t+o,i,t+o,i+a.tr),e.lineTo(t+o,i+r-a.br),e.quadraticCurveTo(t+o,i+r,t+o-a.br,i+r),e.lineTo(t+a.bl,i+r),e.quadraticCurveTo(t,i+r,t,i+r-a.bl),e.lineTo(t,i+a.tl),e.quadraticCurveTo(t,i,t+a.tl,i),e.closePath(),n&&e.fill(),s&&e.stroke()},Drawing.drawEllipse=function(e,t,i,o,r,a,n){var s=t-o,h=i-r,l=2*o,c=2*r,d=.5522848,p=o*d,m=r*d,u=s+l,g=h+c;e.beginPath(),e.moveTo(s,i),e.bezierCurveTo(s,i-m,t-p,h,t,h),e.bezierCurveTo(t+p,h,u,i-m,u,i),e.bezierCurveTo(u,i+m,t+p,g,t,g),e.bezierCurveTo(t-p,g,s,i+m,s,i),a&&(e.fillStyle=a,e.fill()),n&&(e.strokeStyle=n),e.stroke()},Drawing.drawLines=function(e,t,i,o,r,a){e.beginPath(),a&&(e.strokeStyle=a);for(var n=o.split(" "),s=0,h=n.length;h>s;s++){var l=n[s++];switch(l){case"M":var c=parseInt(n[s++])+t,d=parseInt(n[s])+i;e.moveTo(c,d);break;case"L":var c=parseInt(n[s++])+t,d=parseInt(n[s])+i;e.lineTo(c,d)}}r&&(e.fillStyle=r,e.fill()),e.stroke()},document.addEventListener("dragstart",function(e){3===e.target.nodeType&&(e.preventDefault(),e.stopPropagation())},!1),MagicBoard.eventStart=function(e){MagicBoard.indicators.mouseDown=!0;var t=MagicBoard.getPos(e);MagicBoard.indicators.click=t;var i=MagicBoard.indicators.mouseover.length;if(!MagicBoard.indicators.hilight&&i>0){i--;for(var o=MagicBoard.indicators.mouseover[i];o.parentShape;)o=MagicBoard.indicators.mouseover[i--];o.parentShape&&(o=o.parentShape),MagicBoard.indicators.lineActive=o}MagicBoard.indicators.doubleClick++,setTimeout(function(){MagicBoard.indicators.doubleClick--},800)},MagicBoard.eventContinue=function(e){if(MagicBoard.indicators.mouseDown){var t=MagicBoard.indicators.click,i=null,o=MagicBoard.getPos(e);i=MagicBoard.indicators.hilight,i?MagicBoard.indicators.resize>-1?(i.resizeContinue(o,t),MagicBoard.indicators.resizeStarted=o):(MagicBoard.indicators.moveStarted=o,i.move(o,t)):(i=MagicBoard.indicators.lineActive,i&&i.lineTo(o))}},MagicBoard.eventStop=function(){if(MagicBoard.indicators.mouseDown=!1,MagicBoard.indicators.moveStarted){var e=MagicBoard.indicators.hilight,t=MagicBoard.indicators.moveStarted,i=MagicBoard.indicators.click,o=e.getDimension(),r=t.x-i.x,a=t.y-i.y,n=o.top+a,s=o.left+r;e.setPosition({x:s,y:n}),MagicBoard.indicators.moveStarted=null,e.selectToggle()
}else{var h=MagicBoard.indicators.mouseover.length;if(h>0){h--;for(var l=MagicBoard.indicators.mouseover[h];l.parentShape;)l=MagicBoard.indicators.mouseover[h--];var c=MagicBoard.indicators.lineActive;if(MagicBoard.indicators.resize>-1){var e=MagicBoard.indicators.hilight;e.resizeStop()}else c&&c!==l&&c!==l.parentShape?c.connectTo(l):l.click()}else if(MagicBoard.indicators.lineActive){var d=MagicBoard.sheetBook.scratchCtx,p=MagicBoard.sheetBook.scratchCanvas;d.clearRect(0,0,p.width,p.height)}else MagicBoard.indicators.resize>-1&&(e=MagicBoard.indicators.hilight,e.resizeStop())}if(MagicBoard.indicators.lineActive=null,MagicBoard.indicators.click=null,MagicBoard.indicators.doubleClick>1){var h=MagicBoard.indicators.mouseover.length;if(h>0)for(var m=0;h>m;m++){var e=MagicBoard.indicators.mouseover[m];e.doubleClick()}}},MagicBoard.keyUp=function(e){var t=e.which;switch(e.ctrlKey?MagicBoard.indicators.keyType="ctrlKey":e.shiftKey&&(MagicBoard.indicators.keyType="shiftKey"),t){case 8:case 46:if(MagicBoard.indicators.hilight){var i=MagicBoard.indicators.hilight;i.click(),i.deleteShape()}case 90:case 122:"ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.sheetBook.currentSheet.undo();default:return}},MagicBoard.getPos=function(e){var t,i,o=0,r=0;return e.pageX||e.pageY?(t=e.pageX-document.body.scrollTop,i=e.pageY-document.body.scrollTop):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t-o-MagicBoard.boardPos.x,y:i-r-MagicBoard.boardPos.y}};var Utility={Shape:{},Sheet:{},SheetBook:{}};Utility.SheetBook.createWorkItems=function(e){e.connectCanvas=document.createElement("canvas"),e.connectCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),this.connectCtx=null,e.connectCanvas.setAttribute("name","workItem"),e.connectCanvas.height=e.cheight,e.connectCanvas.width=e.cwidth,e.connectCtx=e.connectCanvas.getContext("2d"),e.connectCtx.translate(.5,.5),e.scratchCanvas=document.createElement("canvas"),e.scratchCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),e.scratchCtx=null,e.scratchCanvas.setAttribute("name","workItem"),e.scratchCanvas.height=e.cheight,e.scratchCanvas.width=e.cwidth,e.scratchCtx=e.scratchCanvas.getContext("2d"),e.scratchCtx.translate(.5,.5),e.hilighter=document.createElement("div"),e.hilighter.setAttribute("style","visibility:hidden;height:100px;width:100px;left:0px;top:0px;z-index:10"),e.hilighter.setAttribute("class","hilight"),e.hilighter.onmouseover=function(){MagicBoard.indicators.hilight&&MagicBoard.indicators.mouseover.push(MagicBoard.indicators.hilight)},e.hilighter.onmouseout=function(){event.preventDefault(),MagicBoard.indicators.mouseover=[]},e.hilighter.innerHTML="<div class='stretcher'><div class='red'></div></div><div class='stretcher'><div class='red'></div></div><div class='stretcher'><div class='red'></div></div><div class='stretcher'><div class='red'></div></div><div class='clickPrompt' onclick='Utility.Shape.showProperty()'></div>";var t=e.hilighter.children,i=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=-1)};t[0].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=0)},t[0].onmouseout=i,t[1].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=1)},t[1].onmouseout=i,t[2].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=2)},t[2].onmouseout=i,t[3].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=3)},t[3].onmouseout=i,e.textEditor=document.createElement("div"),e.textEditor.setAttribute("contenteditable","true"),e.textEditor.setAttribute("style","position:absolute;left:0px;top:0px;width:10px;height:14px;display:none;background:white;z-index:100"),document.body.appendChild(e.textEditor),e.textEditor.onblur=function(){e.textEditor.style.display="none";var t=e.textEditor.targetShape;t.updateText(e.textEditor.innerHTML),t.selectToggle(),e.textEditor.targetShape=null},e.star=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.star.setAttribute("style","display:none;position:absolute;left:0px;top:0px;z-index:10;width:50px;height:21px"),e.star.innerHTML='<polygon points="10,1 4,20 19,8 1,8 16,20" style="fill:red;stroke:red;stroke-width:1;fill-rule:nonzero;" />',e.star.onclick=function(){var t=e.star.cLine;t&&t.click()},Utility.SheetBook.attachWorkItems(e)},Utility.SheetBook.attachWorkItems=function(e){sheetCanvas=e.anchor,sheetCanvas.appendChild(e.scratchCanvas),sheetCanvas.appendChild(e.connectCanvas),sheetCanvas.appendChild(e.hilighter),sheetCanvas.appendChild(e.star)},Utility.SheetBook.activateHilighter=function(e){var t=e.left-4,i=e.top-4,o=e.width+8,r=e.height+8,a=MagicBoard.sheetBook.hilighter;a.style.visibility="visible",a.style.left=t+"px",a.style.top=i+"px",a.style.width=o+"px",a.style.height=r+"px";var n=a.children,s=n[0].style;s.left="-12px",s.top=r/2-12+"px",s.cursor="ew-resize";var h=n[1].style;h.left=o-14+"px",h.top=r/2-12+"px",h.cursor="ew-resize";var l=n[2].style;l.left=o/2-12+"px",l.top="-12px",l.cursor="ns-resize";var c=n[3].style;c.left=o/2-12+"px",c.top=r-14+"px",c.cursor="ns-resize"},Utility.Sheet.Markers=function(e){var t="<defs><marker id='fillArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='rgb(27,141,17)'></path></marker><marker id='fillArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='rgb(27,141,17)'></path></marker><marker id='hollowArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='fillDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='rgb(27,141,17)' ></path></marker><marker id='dot' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><circle r='3' cx='3' cy='3' fill='rgb(27,141,17)' ></circle></marker><marker id='lineArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L9,3 L0,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='lineArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M9,0 L0,3 L9,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker></defs>";e.canvas.innerHTML=t},Utility.Sheet.isGridAvailable=function(e,t,i){var o=i.dimension,r=t.courseGrids,a=r.length,n=t.noOfXcourseGrids,s=(t.noOfYcourseGrids,10),h=MagicBoard.sheetBook.cwidth,l=MagicBoard.sheetBook.cheight;if(-1===e){var c=0,d=0;o.left&&(c=o.left),e=Utility.Sheet.LeftAlignedFreeGrid(c,d,t);for(var p=e;a>p;p++){var m=r[p];if(!m.filled)return Utility.Sheet.isGridAvailable(p,t,i)}}var u=r[e],g=u.x1+s,v=u.y1+s,f={x:g,y:v},y={x:g+o.width,y:v};if(y.x>h)return Utility.Sheet.isGridAvailable(e+1,t,i);var k={x:g,y:v+o.height};if(k.y>l)return[];for(var x=({x:g+o.width,y:v+o.height},Math.floor(e/n)+1,[]),B=e;a>B;B++){var S,b,w,M,m=r[B];if(S=m.x1,b=m.x2,w=m.y1,M=m.y2,!(b<f.x||S>y.x)){if(w>k.y)break;if(!(M<f.y)){if(m.filled){for(var C=B;a>C;C++){if(C>=a)return[];if(!r[C].filled)break}var T=Utility.Sheet.isGridAvailable(C,t,i);if(T.length>0)return T}x.push(B)}}}return x},Utility.Sheet.LeftAlignedFreeGrid=function(e,t,i){var o=i.noOfXcourseGrids,r=i.courseGrids;return startGridSeq=Math.floor(t/i.courseGridSize.y)*o+Math.floor(e/i.courseGridSize.x),startGridSeq>r.length?0:r[startGridSeq].filled?e?Utility.Sheet.LeftAlignedFreeGrid(e,t+i.courseGridSize.y,i):startGridSeq++:startGridSeq},Utility.Sheet.findOwner=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,o=0;i>o;o++){var r=t.shapes[o];if(r.dom===e)return r.dom;for(var a=r.components.length,n=0;a>n;n++){var s=r.components[n];if(s.dom===e)return s}}return null},Utility.Sheet.connectIds=function(){for(var e=MagicBoard.sheetBook.currentSheet,t=e.shapes.length,i=0;t>i;i++){var o=e.shapes[i];if(o.connectedFromIds)for(var r=0,a=o.connectedFromIds.length;a>r;r++){var n=o.connectedFromIds[r];o.connectedFrom.push(Utility.Sheet.findShapeById(n))}if(o.connectedToIds)for(var r=0,a=o.connectedToIds.length;a>r;r++){var s=o.connectedToIds[r];o.connectedTo.push(Utility.Sheet.findShapeById(s))}}for(var i=0;t>i;i++){var o=e.shapes[i];o.refreshConnection()}},Utility.Sheet.findShapeById=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,o=0;i>o;o++){var r=t.shapes[o];if(r.id===e)return r}},Utility.Shape.applyProperty=function(){var e=document.getElementById("propPrompt"),t=e.shape;e.shape=null;for(var i=e.getElementsByClassName("prop"),o=i.length,r=0;o>r;r++){var a=i[r],n=a.getAttribute("data-dirty");if(n&&"1"===n){var s,h=a.getAttribute("data-propKey"),l=a.getAttribute("data-propType"),c=a.getAttribute("data-propName");"INPUT"===a.nodeName?s=a.value:"SELECT"===a.nodeName&&(s=a.options[a.selectedIndex].value),t.applyProperty(h,c,l,s)}}Utility.destroyDom(e,"dom")},Utility.addChangeFlag=function(){var e=event.target;e.setAttribute("data-dirty","1")},Utility.Shape.showProperty=function(){{var e="",t=MagicBoard.indicators.hilight,i=t.properties;i.length}for(var o in i){var r=MagicBoard.properties[o];if("input"===r.field)e+="<label class='propLabel'>"+r.label+":</label><input class='propInput prop' data-propKey='"+o+"' class='prop' data-propType='"+r.propType+"'  data-propName='"+r.propName+"' type='"+r.values[0].type+"' value='"+r.values[0].value+"' onchange='Utility.addChangeFlag()'/><BR/>";else if("select"===r.field){e+="<label class='propLabel' >"+r.label+":</label><select onchange='Utility.addChangeFlag()' data-propKey='"+o+"' class='prop' data-propType='"+r.propType+"'  data-propName='"+r.propName+"'  >";for(var a=0,n=r.values.length;n>a;a++)e+="<option value='"+r.values[a].value+"' >"+r.values[a].name+"</option>";e+="</select><BR/>"}}if(e){e+="<br/><button class='apply button' onclick='Utility.Shape.applyProperty()'>Apply</button><button class='cancel button' onclick='Utility.destroyDom(\"propPrompt\",\"id\")'>Cancel</button>";var s=document.createElement("div");s.setAttribute("class","prompt"),s.setAttribute("style",""),s.setAttribute("id","propPrompt"),s.innerHTML=e,s.shape=t,document.body.appendChild(s)}},Utility.Shape.align=function(e){var t=MagicBoard.sheetBook.alignments.x,i=MagicBoard.sheetBook.alignments.y,o=9999,r=9999,a=e.x;nearestY=e.y;for(var n in t)if(t[n]&&t[n].length>0){var s=Math.abs(e.y-n);r>s&&(r=s,nearestY=n)}for(var h in i)if(i[h]&&i[h].length>0){var s=Math.abs(e.x-h);o>s&&(o=s,a=h)}return Math.abs(e.x-a)<20&&("string"==typeof a&&(a=parseInt(a)),e.x=a),Math.abs(e.y-nearestY)<20&&("string"==typeof nearestY&&(nearestY=parseInt(nearestY)),e.y=nearestY),e},Utility.Sheet.drawCourseGrid=function(e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height),t.setLineDash([1,15]),t.beginPath();for(var o=0,r=0;r<e.noOfYcourseGrids;r++){var a=r*e.courseGridSize.y;t.moveTo(0,a),t.lineTo(MagicBoard.sheetBook.cwidth,a);for(var n=0;n<e.noOfXcourseGrids;n++){var s=n*e.courseGridSize.x;t.moveTo(s,0),t.lineTo(s,MagicBoard.sheetBook.cheight);var h="Filled "+o,l=e.courseGrids[o++];l.filled&&t.fillText(h,s+20,a+20)}}t.stroke()},Utility.Shape.blockGrids=function(e){var t=e.currentSheet,i=e.dimension,o=t.courseGrids;Utility.Shape.unblockGrids(e,o);for(var r=i.left,a=i.top,n=Math.floor(r/t.courseGridSize.x),s=Math.floor(a/t.courseGridSize.y),h=s*t.noOfXcourseGrids+n,l={x:r,y:a},c={x:r+i.width,y:a},d={x:r,y:a+i.height},o=({x:r+i.width,y:a+i.height},t.courseGrids),p=o.length,m=h;p>m;m++){var u,g,v,f,y=o[m];if(u=y.x1,g=y.x2,v=y.y1,f=y.y2,!(g<l.x||u>c.x)){if(v>d.y)break;f<l.y||(y.filled=!0,y.shapes.push(e),e.occupiedGrids.push(m))}}},Utility.Shape.unblockGrids=function(e,t){for(var i=e.occupiedGrids,o=i.length,r=0;o>r;r++){for(var a=i[r],n=t[a],s=n.shapes,h=s.length,l=0;h>l;l++){var c=s[l];if(c===e){s.splice(l,1);break}}0===s.length&&(n.filled=!1)}e.occupiedGrids=[]},Utility.Shape.calculateConnectionPoints=function(e,t){var i,o,r,a,n=e.getDimension(),s=t.getDimension(),h=n.edgePoints,l=s.edgePoints,c="horiz";if(h.c1.x>l.c2.x){var d=h.m41.x-l.m23.x;if(d>50)i=h.m41.x,r=h.m41.y,o=l.m23.x,a=l.m23.y;else{var p=h.m41.y-l.m23.y,m=(h.m12.x-l.m23.x,h.m12.y-l.m23.y),u=(h.m12.x-l.m23.x,h.m12.y-l.m23.y);if(m>50)h.m12.x-l.m34.x>50?(i=h.m12.x,r=h.m12.y,o=l.m34.x,a=l.m34.y,c="vert"):(i=h.m12.x,r=h.m12.y,o=l.m23.x,a=l.m23.y,c="horizvert");else if(u>50)i=h.m34.x,r=h.m34.y,o=l.m23.x,a=l.m23.y,c="horizvert";else if(p>50){var g=h.m41.y-l.m34.y;g>50?(i=h.m41.x,r=h.m41.y,o=l.m34.x,a=l.m34.y):(i=h.m41.x,r=h.m41.y,o=l.m23.x,a=l.m23.y)}else i=h.m41.x,r=h.m41.y,o=l.m23.x,a=l.m23.y}}else if(h.c2.x<l.c1.x){var v=h.m41.x-l.m23.x;if(v>50)i=h.m23.x,r=h.m23.y,o=l.m41.x,a=l.m41.y;else{var f=(h.m23.y-l.m41.y,h.m23.x-l.m12.x,h.m23.y-l.m12.y),y=(h.m23.x-l.m34.x,h.m23.y-l.m34.y);Math.abs(y)>50?(i=h.m23.x,r=h.m23.y,y>0?(o=l.m34.x,a=l.m34.y):(o=l.m12.x,a=l.m12.y),c="horizvert"):f>50?l.m41.x-h.m23.x>50?(i=h.m23.x,r=h.m23.y,o=l.m41.x,a=l.m41.y):(i=h.m23.x,r=h.m23.y,o=l.m12.x,a=l.m12.y,c="horizvert"):(i=h.m23.x,r=h.m23.y,o=l.m41.x,a=l.m41.y)}}else h.c1.y>l.c3.y?(i=h.m12.x,r=h.m12.y,o=l.m34.x,a=l.m34.y,c="vert"):(i=h.m34.x,r=h.m34.y,o=l.m12.x,a=l.m12.y,c="vert");return{beginShape:e,endShape:t,pos:{x1:i,x2:o,y1:r,y2:a},orientation:c}},Utility.Sheet.removeConnection=function(e,t,i){for(var o=e.connections,r=o.length,a=0;r>a;a++){var n=o[a];if(n.beginShape===t&&n.endShape===i)return void o.splice(a,1)}},Utility.Shape.dataFormatter=function(e,t,i){if(void 0==e)return 0;if("number"==typeof e)return e;if("string"==typeof e){if(e.indexOf("px")>-1)return parseInt(e.replace("px",""));if(e.indexOf("%")>-1){if(!i)return console.log(" In order to calculate %, we need the shape, that is missing in the call"),0;var o=parseInt(e.replace("%","")),r=null;if(i.parentShape)r=i.parentShape.dimension;else{var a=MagicBoard.sheetBook;r={left:0,top:0,width:a.cwidth,height:a.cheight}}var n=t;return"left"===t?n="width":"top"===t&&(n="height"),r[n]*o/100}}},Utility.Shape.recalculateDimensions=function(e){var t=e.dimension;if(t.misc.unit&&"%"===t.misc.unit)for(var i=t.misc.key,o=i.length,r=0;o>r;r++){var a=i[r],n=e.style[a],s=Utility.Shape.dataFormatter(n,a,e);t[a]=s}},Utility.destroyDom=function(e,t){var i=MagicBoard.sheetBook.garbage,o=null;"id"===t?o=document.getElementById(e):"dom"===t&&(o=e),i.appendChild(o),i.innerHTML=""};var Logger=function(){},Info=function(){};inheritsFrom(Info,Logger),Info.prototype.console=function(e){console.log("Info - "+e)};var Warning=function(){};inheritsFrom(Warning,Logger),Warning.prototype.console=function(e){console.log("Warning - "+e)};var Error=function(){};inheritsFrom(Error,Logger),Error.prototype.console=function(e){Error.log("Error - "+e)};var info=new Info,warning=new Warning,error=new Error;