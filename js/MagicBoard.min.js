var inheritsFrom=function(e,t){e.prototype=Object.create(t.prototype)},MagicBoard={sheetBook:null,indicators:{mouseDown:!1,mouseover:[],click:!1,doubleClick:0,resize:-1},boardPos:{x:0,y:0}};MagicBoard.properties={"background-color":{propType:"attribute",propName:"fill",label:"Background Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"border-color":{propName:"stroke",propType:"attribute",label:"Border Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"border-width":{propName:"stroke-width",propType:"attribute",label:"Border Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"border-style":{propName:"stroke-dasharray",propType:"attribute",label:"Border Style",field:"select",values:[{name:"Dash",value:"5,5",type:""},{name:"Solid",value:"",type:""},{name:"Dotted",value:"1,1",type:""}]},text:{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{name:"",value:"",type:"text"}]},"text-color":{propName:"fill",propType:"attribute",label:"Text Color",field:"input",values:[{name:"",value:"#ffffff",type:"color"}]},"font-size":{propName:"font-size",propType:"attribute",label:"Font Color",field:"input",values:[{name:"",value:"14",type:"text"}]},"font-weight":{propName:"font-weight",propType:"attribute",label:"Font Weight",field:"select",values:[{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"}]},"text-content":{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{value:""}]},"line-type":{propName:"",propType:"function",field:"select",label:"Line Type",values:[{name:"Straight",value:"straight"},{name:"Zig Zag",value:"zig-zag"},{name:"Brezier Curve",value:"brezier"},{name:"Quadratic Curve",value:"quadratic"}]},"line-color":{propName:"stroke",propType:"attribute",label:"Line Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"line-width":{propName:"stroke-width",propType:"attribute",label:"Line Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"line-style":{propName:"stroke-dasharray",propType:"attribute",label:"Line Style",field:"select",values:[{name:"Solid",value:"",type:""},{name:"Dash",value:"5,5",type:""},{name:"Dotted",value:"1,1",type:""}]},"end-marker":{propName:"marker-end",propType:"attribute",label:"End Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowE)"},{name:"Hollow Arrow",value:"url(#hollowArrowE)"},{name:"Regular Arrow",value:"url(#lineArrowE)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"start-marker":{propName:"marker-start",propType:"attribute",label:"Start Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowS)"},{name:"Hollow Arrow",value:"url(#hollowArrowS)"},{name:"Regular Arrow",value:"url(#lineArrowS)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"mid-marker":{propName:"marker-mid",propType:"attribute",field:"select",label:"Mid Marker",values:[{name:"Dot",value:"url(#dot)"}]}};var SheetBook=function(e,t,i){this.cheight=400,this.cwidth=400,this.sheets=[],this.currentSheet=null,this.anchor=document.body,this.alignments={x:[],y:[]},this.maxRedo=5,this.garbage=document.createElement("div"),this.garbage.setAttribute("style","display:none"),document.body.appendChild(this.garbage),i&&(this.cheight=i),t&&(this.cwidth=t),e&&(this.anchor=e);var r=e.getBoundingClientRect();MagicBoard.boardPos={x:r.left,y:r.top},Utility.SheetBook.createWorkItems(this),document.onmousedown=function(e){return MagicBoard.eventStart(e)},document.onmousemove=function(e){MagicBoard.eventContinue(e)},document.onmouseup=function(e){MagicBoard.eventStop(e)},document.onkeyup=function(e){event.preventDefault(),MagicBoard.keyUp(e)}};SheetBook.prototype.zoom=function(){},SheetBook.prototype.setAnchorElement=function(e){this.anchor=e},SheetBook.prototype.addSheet=function(e){this.sheets.push(e);var t=e.getCanvas();t.setAttribute("height",this.cheight),t.setAttribute("width",this.cwidth),t.style.width=this.cwidth+"px",t.style.height=this.cheight+"px",this.anchor.appendChild(t),this.setCurrentSheet(e)},SheetBook.prototype.getSheet=function(e){for(var t=this.sheets.length-1;t>-1;t--){var i=this.sheets[t];if(i.name===e)return i}return null},SheetBook.prototype.getCurrentSheet=function(){return this.currentSheet},SheetBook.prototype.setCurrentSheet=function(e){var t=this.currentSheet;t&&(t.canvas.style.visibility="hidden");var i=null,r=!1;"string"==typeof e&&(i=e,r=!0);for(var o=this.sheets.length-1;o>-1;o--){var a=this.sheets[o];if(r){if(a.name===i)break}else if(a===e)break}this.currentSheet=e,e.canvas.style.visibility="visible";var n=this.connectCanvas;MagicBoard.sheetBook.connectCtx.clearRect(0,0,n.width,n.height)},SheetBook.prototype.getCombinedImage=function(){var e=this.scratchCtx;if(e){e.clearRect(0,0,this.cwidth,this.cheight);for(var t=this.shapes.length,i=0;t>i;i++){var r=this.shapes[i];r.draw(e)}var o=this.scratchCanvas.toDataURL();return o}},SheetBook.prototype.setHeight=function(e){this.cheight=e,this.currentCanvas.setAttribute("height",this.cheight)},SheetBook.prototype.setWidth=function(e){this.cwidth=e,this.currentCanvas.setAttribute("width",e)};var Sheet=function(e){this.options={},e&&(this.options=e),this.name="Sheet1",e.name&&(this.name=e.name),this.canvas=null,this.init()};Sheet.prototype.init=function(){this.removedShapes=[],this.canvas=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.canvas.setAttribute("id",this.name),this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px",this.canvas.style["z-index"]="1",this.canvas.setAttribute("name","mg"),this.canvas.style.visibility="visible";var e=this.options["background-color"];e&&(this.canvas.style.fill=e),this.connections=[],Utility.Sheet.Markers(this),this.courseGridSize={x:100,y:100},this.noOfXcourseGrids=Math.floor(MagicBoard.sheetBook.cwidth/this.courseGridSize.x),this.noOfYcourseGrids=Math.floor(MagicBoard.sheetBook.cheight/this.courseGridSize.y),this.courseGrids=[];for(var t=0,i=0;i<this.noOfYcourseGrids;i++)for(var r=i*this.courseGridSize.y,o=(i+1)*this.courseGridSize.y,a=0;a<this.noOfXcourseGrids;a++){var n=a*this.courseGridSize.x,s=(a+1)*this.courseGridSize.x,h={filled:!1,shapes:[],x1:n,x2:s,y1:r,y2:o,index:t++};this.courseGrids.push(h)}if(MagicBoard.sheetBook.currentSheet=this,this.shapes=[],this.options.shapes)for(var l=0,c=this.options.shapes.length;c>l;l++){var d=new Shape(this.options.shapes[l]);d.draw(),d.addHover()}},Sheet.prototype.getCanvas=function(){return this.canvas},Sheet.prototype.rename=function(e){this.name=e,this.options.name=e},Sheet.prototype.wipe=function(){for(var e=MagicBoard.sheetBook.garbage,t=this.canvas.children,i=t.length-1;i>-1;i--){var r=t[i];"workItem"!==r.getAttribute("name")&&e.appendChild(r)}e.innerHTML=""},Sheet.prototype.totalShapeArea=function(){},Sheet.prototype.addShape=function(e){this.shapes.push(e)},Sheet.prototype.removeLastShape=function(){var e=MagicBoard.sheetBook.maxRedo;if(0!==this.shapes.length){var t=this.shapes[this.shapes.length-1];this.removedShapes.push(t),this.removedShapes.length>e&&this.removedShapes.splice(0,1),this.shapes.pop()}},Sheet.prototype.removeShape=function(e){if(0!==this.shapes.length)for(var t=this.shapes.length-1;t>-1;t--){var i=this.shapes[t];if(i===e)return void this.shapes.splice(t,1)}},Sheet.prototype.reDraw=function(){this.wipe();for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.createCanvas(),i.draw()}},Sheet.prototype.undo=function(){this.removeLastShape(),this.reDraw()},Sheet.prototype.redo=function(){0!==this.removedShapes.length&&(this.shapes.push(this.removedShapes[0]),this.removedShapes.splice(0,1),this.reDraw())},Sheet.prototype.refreshConnections=function(){for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.refreshConnection()}},Sheet.prototype.getImage=function(){var e=document.createElement("canvas");e.height=MagicBoard.sheetBook.cheight,e.width=MagicBoard.sheetBook.cwidth;for(var t=e.getContext("2d"),i=this.shapes,r=i.length,o=0;r>o;o++){var a=i[o];a.drawOnCanvas(t)}var n=e.toDataURL();return n},Sheet.prototype.addConnections=function(e){for(var t=e.beginShape,i=e.endShape,r=this.connections,o=r.length,a=!1,n=0;o>n;n++){var s=r[n],h=e.pos;if(s.beginShape===t&&s.endShape===i)return a=!0,s.pos=h,s.orientation=e.orientation,s}return a||r.push(e),e},Sheet.prototype.save=function(){var e={};e.options=this.options,e.shapes=[];for(var t=0,i=this.shapes.length;i>t;t++){var r=this.shapes[t],o=r.save();o&&e.shapes.push(o)}return e},Sheet.prototype.removeConnections=function(e){for(var t=e.connectedFrom,i=(t.length,0);a>i;i++){var r=t[i];Utility.Sheet.removeConnection(this,r,e)}for(var o=e.connectedTo,a=o.length,n=0;a>n;n++){var s=o[n];Utility.Sheet.removeConnection(this,e,s)}},Sheet.prototype.drawConnections=function(e){if(!e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height)}for(var r=this.connections,o=r.length,a=0;o>a;a++){var n=r[a];n.shape&&(n.shape.deleteShape(!0),n.shape=null);var s=new ConnectorLine(n);s.draw()}};var Point=function(e,t){this.x=e,this.y=t},DrawingObject=function(){this.draw=function(){}},Shape=function(e){this.param=JSON.parse(JSON.stringify(e.param)),this.frame=JSON.parse(JSON.stringify(e.frame)),e.events?this.events=e.events:this.events={click:{override:null,post:null,pre:null},hover:{override:null,post:null,pre:null},doubleClick:{override:null,post:null,pre:null}},e.connectedFromIds&&(this.connectedFromIds=e.connectedFromIds),e.connectedToIds&&(this.connectedToIds=e.connectedToIds),e.id&&(this.id=e.id),this.properties={},this.components=[];for(var t=e.componentParms.length,i=0;t>i;i++){var r=new ShapeComponent(e.componentParms[i]);this.components.push(r);for(var o in r.properties)this.properties[o]=!0}this.init()};inheritsFrom(Shape,DrawingObject),Shape.prototype.init=function(){this.children||(this.children=[]),this.components||(this.components=[]),this.param.alignmentRails||(this.param.alignmentRails=!0),this.occupiedGrids=[],this.currentSheet=MagicBoard.sheetBook.getCurrentSheet(),this.sheetCanvas=this.currentSheet.getCanvas(),this.frame&&this.createCanvas();this.dimension=this.frame,this.id||(this.id=this.currentSheet.shapes.length),this.currentSheet.addShape(this),this.connectedTo=[],this.connectedFrom=[]},Shape.prototype.createCanvas=function(){var e=Utility.Shape.dataFormatter(this.frame.width,"width",this);this.frame.width=e;var t=Utility.Shape.dataFormatter(this.frame.height,"height",this);this.frame.height=t;var i=document.createElementNS("http://www.w3.org/2000/svg","g");this.dom=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.dom.setAttribute("name","mg"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("width",e),this.dom.setAttribute("height",t),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("style","position:absolute;-ms-user-select:none;-webkit-user-select:none;z-index:10;transform:translate(1.5,1.5);z-index:1"),this.dom.setAttribute("x",Utility.Shape.dataFormatter(this.frame.left,"left",this)),this.dom.setAttribute("y",Utility.Shape.dataFormatter(this.frame.top,"top",this)),i.appendChild(this.dom),this.sheetCanvas.appendChild(i)},Shape.prototype.addComponent=function(e){this.components.push(e)},Shape.prototype.addHover=function(){var e=this,t=this.dom;t.onmouseover=function(){MagicBoard.indicators.mouseover.push(e)},t.onmouseout=function(){event.preventDefault();for(var t=MagicBoard.indicators.mouseover.length-1;t>-1;t--)if(MagicBoard.indicators.mouseover[t]===e)return void MagicBoard.indicators.mouseover.splice(t,1)}},Shape.prototype.click=function(){var e=this.events;if(e){if(e.click||(e.click={override:null,pre:null,post:null}),e.click.override)return window[e.click.override].call(this);e.click.pre&&window[e.click.pre].call(this)}this.selectToggle()},Shape.prototype.doubleClick=function(){var e=this,t=event.target;if(t instanceof SVGTextElement){var i=t.getBoundingClientRect(),r=MagicBoard.sheetBook.textEditor;r.style.left=i.left-2,r.style.top=i.top-2,r.style.width=i.width+4,r.style.height=i.height+4,r.style.display="block",r.innerHTML=t.innerHTML,r.targetShape=e,r.focus()}},Shape.prototype.move=function(e,t){var i=this.getDimension(),r=e.y-t.y,o=e.x-t.x,a=i.top+r,n=i.bottom+r,s=i.left+o,h=i.right+o,l=MagicBoard.sheetBook.scratchCtx,c=MagicBoard.sheetBook.scratchCanvas;l.clearRect(0,0,c.width,c.height),l.beginPath(),l.strokeStyle="green",l.setLineDash([2,2]),l.lineWidth=4,l.rect(s-2,a-2,i.width+4,i.height+4),l.stroke(),this.alignmentCheck(l,c.width,c.height,a,s,n,h)},Shape.prototype.resizeContinue=function(e,t){var i=(MagicBoard.sheetBook.hilighter,MagicBoard.indicators.resize);if(2>i){var r=e.x-t.x;Utility.Shape.resize(this,r,-1)}else if(4>i){var o=e.y-t.y;Utility.Shape.resize(this,-1,o)}else{var r=e.x-t.x,o=e.y-t.y;Utility.Shape.resize(this,r,o)}Utility.SheetBook.resizeHilighter(this.dimension,this)},Shape.prototype.resizeStop=function(){var e=(MagicBoard.indicators.resizeStarted,MagicBoard.indicators.click,{x:this.dimension.left,y:this.dimension.top},MagicBoard.sheetBook.hilighter);e.style.visibility="hidden",e.style.transform="",this.dom.style.transform="",this.dimension.resizeX=null,this.dimension.resizeY=null,this.dimension.resizeWidth=null,this.dimension.resizeHeight=null,MagicBoard.indicators.resize=-1,MagicBoard.indicators.resizeStarted=null,this.selectToggle()},Shape.prototype.lineTo=function(e){var t=this.getDimension(),i=MagicBoard.sheetBook.scratchCtx,r=MagicBoard.sheetBook.scratchCanvas;i.clearRect(0,0,r.width,r.height),i.beginPath(),i.strokeStyle="gray",i.lineWidth=1,i.setLineDash([5,5]),i.moveTo(t.cx,t.cy),i.lineTo(e.x,e.y),i.stroke(),i.setLineDash([5,0]);var o=Drawing.getLineAngle(e.x,e.y,t.left,t.top);Drawing.drawArrow(i,e.x,e.y,o)},Shape.prototype.refreshConnection=function(e){for(var t=this.currentSheet,i=this.connectedFrom,r=i.length,o=0;r>o;o++){var a=i[o],n=Utility.Shape.calculateConnectionPoints(a,this);t.addConnections(n),t.drawConnections(e)}for(var s=this.connectedTo,h=s.length,l=0;h>l;l++){endShape=s[l];var n=Utility.Shape.calculateConnectionPoints(this,endShape);t.addConnections(n),t.drawConnections(e)}},Shape.prototype.connectFrom=function(e){for(var t=this.connectedFrom,i=!1,r=t.length,o=0;r>o;o++){var a=t[o];if(e===a)break}i||this.connectedFrom.push(e)},Shape.prototype.connectTo=function(e,t){var i=this.events;if(!t){if(i&&i.connectTo.override)return void window[i.connectTo.override].call(this,e);t={type:"TWOBEND",end:"FILLED",begin:null}}var r=this;this.parentShape&&(r=this.parentShape),e.parentShape&&(e=e.parentShape);for(var o=this.connectedTo,a=!1,n=o.length,s=0;n>s;s++){var h=o[s];if(e===h)break}a||r.connectedTo.push(e),e.connectFrom(r);var l=Utility.Shape.calculateConnectionPoints(r,e,t);i&&i.connectTo.click&&(l.events||(l.events={}),l.events.click=i.connectTo.click);var c=MagicBoard.sheetBook.currentSheet;c.addConnections(l),c.drawConnections()},Shape.prototype.alignmentCheck=function(e,t,i,r,o,a,n,s){e.beginPath(),e.strokeStyle="gray",e.lineWidth=1,e.setLineDash([5,5]),MagicBoard.sheetBook.alignments.x[r]&&(e.moveTo(0,r),e.lineTo(t,r)),MagicBoard.sheetBook.alignments.x[a]&&(e.moveTo(0,a),e.lineTo(t,a)),MagicBoard.sheetBook.alignments.y[o]&&(e.moveTo(o,0),e.lineTo(o,i)),MagicBoard.sheetBook.alignments.y[n]&&(e.moveTo(n,0),e.lineTo(n,i)),e.stroke(),e.setLineDash([5,0])},Shape.prototype.setPosition=function(e,t){this.param.alignmentRails&&this.removeAlignments();var i=this.frame;t?(e=Utility.Shape.align(e),this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y)):(this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y)),i.left=e.x,i.top=e.y,i.right=i.left+i.width,i.bottom=i.top+i.height,i.cx=i.left+i.width/2,i.cy=i.top+i.height/2;var r={c1:{x:i.left,y:i.top},c2:{x:i.right,y:i.top},c3:{x:i.right,y:i.bottom},c4:{x:i.left,y:i.bottom},m12:{x:i.cx,y:i.top},m23:{x:i.right,y:i.cy},m34:{x:i.cx,y:i.bottom},m41:{x:i.left,y:i.cy}};i.edgePoints=r,this.refreshConnection(),this.param.alignmentRails&&this.addAlignments(),this.param.noGridBlock||Utility.Shape.blockGrids(this)},Shape.prototype.setDimension=function(e){this.dimension={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.width,height:e.height},this.addAlignments()},Shape.prototype.removeAlignments=function(){var e=function(e,t){if(!e)return!1;var i=e.length;if(2>i)return!1;for(var r=i-1;r>-1;r--){var o=e[r];if(o===t)return void e.splice(r,1)}},t=this.dimension,i=e(MagicBoard.sheetBook.alignments.y[t.left],this);i||(MagicBoard.sheetBook.alignments.y[t.left]=null),i=e(MagicBoard.sheetBook.alignments.y[t.right],this),i||(MagicBoard.sheetBook.alignments.y[t.right]=null),i=e(MagicBoard.sheetBook.alignments.y[t.cx],this),i||(MagicBoard.sheetBook.alignments.y[t.cx]=null),i=e(MagicBoard.sheetBook.alignments.x[t.top],this),i||(MagicBoard.sheetBook.alignments.x[t.top]=null),i=e(MagicBoard.sheetBook.alignments.x[t.bottom],this),i||(MagicBoard.sheetBook.alignments.x[t.bottom]=null),i=e(MagicBoard.sheetBook.alignments.x[t.cy],this),i||(MagicBoard.sheetBook.alignments.x[t.cy]=null)},Shape.prototype.addAlignments=function(){var e=this.dimension;MagicBoard.sheetBook.alignments.y[e.left]||(MagicBoard.sheetBook.alignments.y[e.left]=[]),MagicBoard.sheetBook.alignments.y[e.left].push(this),MagicBoard.sheetBook.alignments.y[e.right]||(MagicBoard.sheetBook.alignments.y[e.right]=[]),MagicBoard.sheetBook.alignments.y[e.right].push(this),MagicBoard.sheetBook.alignments.y[e.cx]||(MagicBoard.sheetBook.alignments.y[e.cx]=[]),MagicBoard.sheetBook.alignments.y[e.cx].push(this),MagicBoard.sheetBook.alignments.x[e.top]||(MagicBoard.sheetBook.alignments.x[e.top]=[]),MagicBoard.sheetBook.alignments.x[e.top].push(this),MagicBoard.sheetBook.alignments.x[e.bottom]||(MagicBoard.sheetBook.alignments.x[e.bottom]=[]),MagicBoard.sheetBook.alignments.x[e.bottom].push(this),MagicBoard.sheetBook.alignments.x[e.cy]||(MagicBoard.sheetBook.alignments.x[e.cy]=[]),MagicBoard.sheetBook.alignments.x[e.cy].push(this)},Shape.prototype.getDimension=function(e){return this.dimension||this.setDimension(this.dom.getBoundingClientRect()),this.dimension},Shape.prototype.applyProperty=function(e,t,i,r,o){for(var a=0,n=this.components.length;n>a;a++){var s=this.components[a],h=s.properties[e];h&&h===o&&s.applyProperty(t,i,r,o)}},Shape.prototype.getProperties=function(){for(var e=[],t=0,i=this.components.length;i>t;t++){var r=this.components[t];for(var o in r.properties){var a=JSON.parse(JSON.stringify(MagicBoard.properties[o]));a.label=r.properties[o],a.keyName=o;var n=r.param[a.propName];if(n)if("input"===a.field)a.values[0].value=n;else if("select"===a.field)for(var s=0,h=a.values.length;h>s;s++)a.values[s].value==n&&(a.values[s].selected=!0);e[e.length]=a}}return e},Shape.prototype.getDom=function(){return this.dom},Shape.prototype.setPoints=function(e){this.points=e},Shape.prototype.getArea=function(){},Shape.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage,t=this.dom.parentNode;e.appendChild(t),e.innerHTML="";for(var i in this)if("object"==typeof this[i]){if("connectedTo"===i){this.connectedTo;MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections()}else"connectedFrom"===i&&(MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections());this[i]=null}},Shape.prototype.selectToggle=function(){var e=this.getDimension(),t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height);var r=MagicBoard.sheetBook.hilighter;if(MagicBoard.indicators.hilight)r.style.visibility="hidden",setTimeout(function(){var e=MagicBoard.indicators.hilight;MagicBoard.indicators.hilight=!1,e.events.click.post&&window[e.events.click.post].call(e)},1),this.addAlignments();else{for(var o=e.left,a=e.top,n=this.parentShape;n;)o+=n.dimension.left,a+=n.dimension.top,n=n.parentShape;Utility.SheetBook.activateHilighter({left:o,top:a,width:e.width,height:e.height},this),MagicBoard.indicators.hilight=this,this.removeAlignments(),this.events.click.post&&window[this.events.click.post].call(this)}},Shape.prototype.updateText=function(e,t){void 0==t&&(t=0);for(var i=0,r=0,o=this.components.length;o>r;r++){var a=this.components[r];if("text"===a.type){if(i===t){a.updateText(e);break}i++}}},Shape.prototype.save=function(){var e={};for(var t in this)if("cInfo"!==t)if("components"!==t)if("connectedFrom"!==t&&"connectedTo"!==t){var i=this[t].constructor.name;("Number"===i||"String"===i||"Object"===i)&&(e[t]=this[t])}else{e[t+"Ids"]=[];for(var r=this[t].length,o=0;r>o;o++){var a=this[t][o];e[t+"Ids"].push(a.id)}}else{e.componentParms=[];for(var r=this.components.length,o=0;r>o;o++){var n=this.components[o];e.componentParms.push(n.save())}}return e},Shape.prototype.draw=function(){var e=this.dom;e.innerHTML="";var t=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(t),this.reDraw(t);for(var i=this.components.length,r=0;i>r;r++){var o=this.components[r];o.parentShape=this;var a=o.construct();a&&t.appendChild(a)}},Shape.prototype.reDraw=function(e){var t=!0;e||(e=this.dom.firstElementChlid,t=!1);for(var i=this.components.length,r=0;i>r;r++){var o=this.components[r];o.parentShape=this;var a=o.construct();t&&a&&e.appendChild(a)}this.refreshConnection()},Shape.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var r=this.components[i];r.drawOnCanvas(e)}e.stroke(),this.refreshConnection(e)};var ConnectorLine=function(e){var t=this;this.cInfo=e;var i=Utility.Shape.defineConnectionCoordinates(this,e);this.param={alignmentRails:!1,noGridBlock:!0},this.components=[];var r={type:"path",origDim:{},dimension:{d:i.d},param:{fill:"none",stroke:"rgb(27,141,17)","stroke-miterlimit":"10","stroke-width":2,cursor:"hand"},lines:i.lines,properties:{"line-style":!0,"line-type":!0,"line-color":!0,"start-marker":!0,"end-marker":!0,"mid-marker":!0}};if(e.connProp.end){var o=e.connProp.end;"FILLED"===o?r.param["marker-end"]="url(#fillArrowE)":"HOLLOW"===o?r.param["marker-end"]="url(#hollowArrowE)":"DOT"===o?r.param["marker-end"]="url(#dot)":"REGULAR"===o&&(r.param["marker-end"]="url(#lineArrowE)")}if(e.connProp.begin){var a=e.connProp.begin;"FILLED"===a?r.param["marker-start"]="url(#fillArrowS)":"HOLLOW"===a?r.param["marker-start"]="url(#hollowArrowS)":"DOT"===a?r.param["marker-start"]="url(#dot)":"REGULAR"===a&&(r.param["marker-start"]="url(#lineArrowS)")}if(e.connProp.style){var n=e.connProp.style;"DASHED"===n?r.param["stroke-dasharray"]="10,5":"DOTTED"===n&&(r.param["stroke-dasharray"]="1,4")}e.param&&(r.param=e.param),e.properties&&(r.properties=e.properties);var s=new ShapeComponent(r);this.components.push(s),this.properties=s.properties,e.events&&(this.events=e.events);var h=s.dom;h.onmouseover=function(){MagicBoard.indicators.mouseover.push(t);var e=MagicBoard.getPos(event),i=MagicBoard.sheetBook.star.style;i.display="block",i.left=e.x-10,i.top=e.y-10,MagicBoard.sheetBook.star.cLine=t},h.onmouseout=function(){event.preventDefault(),setTimeout(function(){MagicBoard.sheetBook.star.style.display="none"},800);for(var e=MagicBoard.indicators.mouseover.length-1;e>-1;e--)if(MagicBoard.indicators.mouseover[e]===t)return void MagicBoard.indicators.mouseover.splice(e,1)},this.init(),e.shape=this,e.properties=s.properties,e.param=s.param};inheritsFrom(ConnectorLine,Shape),ConnectorLine.prototype.save=function(){return null},ConnectorLine.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var r=this.components[i];if(r.drawOnCanvas(e),r.param["marker-end"]){var o=r.param["marker-end"];o="url(#fillArrowE)"===o?"Filled":"url(#hollowArrowE)"===o?"Hollow":"url(#hollowDiamond)"===o?"DiamondHollow":"url(#fillDiamond)"===o?"DiamondFilled":"url(#dot)"===o?"Dot":"Regular";var a=r.lines,n=a[a.length-1];Drawing.drawArrow(e,n.x+this.dimension.left,n.y+this.dimension.top,this.cInfo.angleEnd,o,r.param.fill,r.param.stroke)}if(r.param["marker-start"]){var o=r.param["marker-start"];o="url(#fillArrowS)"===o?"Filled":"url(#hollowArrowS)"===o?"Hollow":"url(#hollowDiamond)"===o?"DiamondHollow":"url(#fillDiamond)"===o?"DiamondFilled":"url(#dot)"===o?"Dot":"Regular";var a=r.lines,s=a[0];Drawing.drawArrow(e,s.x+this.dimension.left,s.y+this.dimension.top,this.cInfo.angleStart,o,r.param.fill,r.param.stroke)}}e.stroke()},ConnectorLine.prototype.deleteShape=function(e){var t=this.cInfo.beginShape,i=this.cInfo.endShape;MagicBoard.sheetBook.currentSheet.removeShape(this);var r=MagicBoard.sheetBook.garbage,o=this.dom.parentNode;if(r.appendChild(o),r.innerHTML="",!e){for(var a=this.currentSheet.connections,n=0,s=a.length;s>n;n++){var h=a[n];if(h.beginShape===t&&h.endShape===i){a.splice(n,1);break}}for(var l in this.cInfo)"object"==typeof this.cInfo[l]&&(this.cInfo[l]=null);for(var c=t.connectedTo,n=0,s=c.length;s>n;n++){var d=c[n];if(d===i){c.splice(n,1);break}}for(var p=i.connectedFrom,n=0,s=p.length;s>n;n++){var d=p[n];if(d===t){p.splice(n,1);break}}}for(var l in this)"object"==typeof this[l]&&(this[l]=null)};var ShapeComponent=function(e){for(var t in e)this[t]=e[t];this.parentShape=null,this.dom=document.createElementNS("http://www.w3.org/2000/svg",this.type);for(var t in this.param)"border-radius"===t?(this.dom.setAttribute("rx",this.param[t]),this.dom.setAttribute("ry",this.param[t])):this.dom.setAttribute(t,this.param[t]);this.innerHTML&&this.dom.appendChild(document.createTextNode(this.innerHTML)),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("transform","translate(1,1)"),this.dom.setAttribute("name","mg"),this.derivedDimension={},this.properties||(this.properties={})};ShapeComponent.prototype.construct=function(){if(this.parentShape){var e=this.dom;this.calculateDimensions();for(var t in this.derivedDimension)this.dom.setAttribute(t,this.derivedDimension[t]);if("image"===this.type){var i=this.xlink;this.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",i)}return e}},ShapeComponent.prototype.save=function(){var e={};for(var t in this){var i=this[t].constructor.name;("String"===i||"Object"===i)&&(e[t]=this[t])}return e},ShapeComponent.prototype.calculateDimensions=function(){var e=0;this.param["stroke-width"]&&(e=parseInt(this.param["stroke-width"])),pw=this.parentShape.frame.width-2*e,ph=this.parentShape.frame.height-2*e;for(var t in this.dimension){var i="",r=this.dimension[t];switch(t){case"width":i=r*pw/100-2*e;break;case"x":case"x1":case"x2":case"cx":i=r*pw/100+e;break;case"rx":case"r":i=r*pw/100-e;break;case"height":i=r*ph/100-2*e;break;case"y":case"y1":case"y2":case"cy":i=r*ph/100+e;break;case"ry":i=r*ph/100-e;break;case"d":this.lines||(this.lines=[]);for(var o=r,a=o.length,n=0;a>n;n++){var s=o[n];if("Z"===s.op.toUpperCase()){i+=" Z ";break}this.lines[n]||this.lines.push({});for(var h in s){var l=s[h];h.indexOf("x")>-1?l=Math.round(s[h]*pw/100):h.indexOf("y")>-1&&(l=Math.round(s[h]*ph/100)),this.lines[n][h]=l,i+=l+" "}}}i&&(this.derivedDimension[t]=i)}if("text"===this.type||"rect"===this.type){if(this.dimension.cx){var c=parseInt(dom.getAttribute("cx"))-parseInt(dom.getAttribute("width"))/2;this.derivedDimension.x=c}if(this.dimension.cy){var d=parseInt(dom.getAttribute("cy"))-parseInt(dom.getAttribute("height"))/2;this.derivedDimension.y=d}}},ShapeComponent.prototype.drawOnCanvas=function(e){var t=this.parentShape.dimension.left,i=this.parentShape.dimension.top,r=0;this.param["stroke-width"]&&(r=parseInt(this.param["stroke-width"]));var o=this.derivedDimension.x+t,a=this.derivedDimension.y+i;o||(o=t),a||(a=i);var n=this.param.fill;"none"===n&&(n="");var s=!1;if(this.param["stroke-dasharray"]){var h=this.param["stroke-dasharray"],l=h.split(",");e.setLineDash(l),s=!0}switch(this.type){case"rect":n?(e.fillStyle=n,e.fillRect(o,a,this.derivedDimension.width,this.derivedDimension.height)):e.strokeRect(o,a,this.derivedDimension.width,this.derivedDimension.height);break;case"circle":break;case"ellipse":var c=this.derivedDimension.cx+t,d=this.derivedDimension.cy+i;Drawing.drawEllipse(e,c,d,this.derivedDimension.rx,this.derivedDimension.ry,n,this.param.stroke);break;case"path":Drawing.drawLines(e,t,i,this.derivedDimension.d,n,this.param.stroke,r);break;case"polyline":break;case"text":n&&(e.fillStyle=n),this.param.stroke&&(e.strokeStyle=this.param.stroke),e.fillText(this.innerHTML,o,a)}s&&e.setLineDash([])},ShapeComponent.prototype.applyProperty=function(e,t,i,r){"attribute"===t?i?(this.dom.setAttribute(e,i),this.param[e]=i):(this.dom.removeAttribute(e),delete this.param[e]):"dom"===t&&(this.innerHTML=i,this.dom.innerHTML="",this.dom.appendChild(document.createTextNode(i)))},ShapeComponent.prototype.updateText=function(e){this.innerHTML=e,this.dom.innerHTML="",this.dom.appendChild(document.createTextNode(e))};var Drawing={};Drawing.getLineAngle=function(e,t,i,r){return Math.atan2(t-r,e-i)},Drawing.getArrowHead=function(e,t,i){var r,o,a,n,s=10;return r=e-s*Math.cos(i-Math.PI/6),a=t-s*Math.sin(i-Math.PI/6),o=e-s*Math.cos(i+Math.PI/6),n=t-s*Math.sin(i+Math.PI/6),{x1:r,x2:o,y1:a,y2:n}},Drawing.drawArrow=function(e,t,i,r,o,a,n){o||(o="Regular"),a&&"none"!==a||(a="");var s,h,l,c,d=15;switch(s=t-d*Math.cos(r-Math.PI/6),l=i-d*Math.sin(r-Math.PI/6),h=t-d*Math.cos(r+Math.PI/6),c=i-d*Math.sin(r+Math.PI/6),e.beginPath(),n&&(e.strokeStyle=n),o){case"Regular":e.moveTo(t,i),e.lineTo(s,l),e.moveTo(t,i),e.lineTo(h,c);break;case"Filled":e.moveTo(t,i),e.lineTo(s,l),e.lineTo(h,c),e.lineTo(t,i),!a&&n&&(a=n),e.fillStyle=a,e.fill();break;case"Hollow":e.moveTo(t,i),e.lineTo(s,l),e.lineTo(h,c),e.lineTo(t,i);break;case"DiamondFilled":var p=l+c-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,l),e.lineTo(m,p),e.lineTo(h,c),e.lineTo(t,i),!a&&n&&(a=n),e.fillStyle=a,e.fill();break;case"DiamondHollow":var p=l+c-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,l),e.lineTo(m,p),e.lineTo(h,c),e.lineTo(t,i);break;case"Dot":var u=t-5*Math.cos(r),g=i-5*Math.sin(r),v=5;e.arc(u,g,v,0,2*Math.PI),!a&&n&&(a=n),e.fillStyle=a,e.fill()}return e.stroke(),{x1:s,x2:h,y1:l,y2:c}},Drawing.roundRect=function(e,t,i,r,o,a,n,s){if("undefined"==typeof s&&(s=!0),"undefined"==typeof a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var h={tl:0,tr:0,br:0,bl:0};for(var l in h)a[l]=a[l]||h[l]}e.beginPath(),e.moveTo(t+a.tl,i),e.lineTo(t+r-a.tr,i),e.quadraticCurveTo(t+r,i,t+r,i+a.tr),e.lineTo(t+r,i+o-a.br),e.quadraticCurveTo(t+r,i+o,t+r-a.br,i+o),e.lineTo(t+a.bl,i+o),e.quadraticCurveTo(t,i+o,t,i+o-a.bl),e.lineTo(t,i+a.tl),e.quadraticCurveTo(t,i,t+a.tl,i),e.closePath(),n&&e.fill(),s&&e.stroke()},Drawing.drawEllipse=function(e,t,i,r,o,a,n){var s=t-r,h=i-o,l=2*r,c=2*o,d=.5522848,p=r*d,m=o*d,u=s+l,g=h+c;e.beginPath(),e.moveTo(s,i),e.bezierCurveTo(s,i-m,t-p,h,t,h),e.bezierCurveTo(t+p,h,u,i-m,u,i),e.bezierCurveTo(u,i+m,t+p,g,t,g),e.bezierCurveTo(t-p,g,s,i+m,s,i),a&&(e.fillStyle=a,e.fill()),n&&(e.strokeStyle=n),e.stroke()},Drawing.drawLines=function(e,t,i,r,o,a){e.beginPath(),a&&(e.strokeStyle=a);for(var n=r.split(" "),s=0,h=n.length;h>s;s++){var l=n[s++];switch(l){case"M":var c=parseInt(n[s++])+t,d=parseInt(n[s])+i;e.moveTo(c,d);break;case"L":var c=parseInt(n[s++])+t,d=parseInt(n[s])+i;e.lineTo(c,d)}}o&&(e.fillStyle=o,e.fill()),e.stroke()},document.addEventListener("dragstart",function(e){3===e.target.nodeType&&(e.preventDefault(),e.stopPropagation())},!1),MagicBoard.eventStart=function(e){var t=e.target.getAttribute("name");if(t){MagicBoard.indicators.mouseDown=!0;var i=MagicBoard.getPos(e);MagicBoard.indicators.click=i;var r=MagicBoard.indicators.mouseover.length;if(!MagicBoard.indicators.hilight&&r>0){r--;for(var o=MagicBoard.indicators.mouseover[r];o.parentShape;)o=MagicBoard.indicators.mouseover[r--];o.parentShape&&(o=o.parentShape),MagicBoard.indicators.lineActive=o;
}MagicBoard.indicators.doubleClick++,setTimeout(function(){MagicBoard.indicators.doubleClick--},400)}},MagicBoard.eventContinue=function(e){if(MagicBoard.indicators.mouseDown){var t=MagicBoard.indicators.click,i=null,r=MagicBoard.getPos(e);i=MagicBoard.indicators.hilight,i?MagicBoard.indicators.resize>-1?(i.resizeContinue(r,t),MagicBoard.indicators.resizeStarted=r):(MagicBoard.indicators.moveStarted=r,i.move(r,t)):(i=MagicBoard.indicators.lineActive,i&&i.lineTo(r))}},MagicBoard.eventStop=function(e){if(MagicBoard.indicators.mouseDown){if(MagicBoard.indicators.mouseDown=!1,MagicBoard.indicators.moveStarted){var t=MagicBoard.indicators.hilight,i=MagicBoard.indicators.moveStarted,r=MagicBoard.indicators.click,o=t.getDimension(),a=i.x-r.x,n=i.y-r.y,s=o.top+n,h=o.left+a;t.setPosition({x:h,y:s}),MagicBoard.indicators.moveStarted=null,t.selectToggle()}else{var l=MagicBoard.indicators.mouseover.length;if(l>0){l--;for(var c=MagicBoard.indicators.mouseover[l];c.parentShape;)c=MagicBoard.indicators.mouseover[l--];var d=MagicBoard.indicators.lineActive;if(MagicBoard.indicators.resize>-1){var t=MagicBoard.indicators.hilight;t.resizeStop()}else d&&d!==c&&d!==c.parentShape?d.connectTo(c):c.click()}else MagicBoard.indicators.lineActive?Utility.SheetBook.clearScratchCanvas():MagicBoard.indicators.resize>-1&&(t=MagicBoard.indicators.hilight,t.resizeStop())}if(MagicBoard.indicators.lineActive=null,MagicBoard.indicators.click=null,MagicBoard.indicators.doubleClick>1){var l=MagicBoard.indicators.mouseover.length;if(l>0)for(var p=0;l>p;p++){var t=MagicBoard.indicators.mouseover[p];t.doubleClick()}}}},MagicBoard.keyUp=function(e){var t=e.which;switch(e.ctrlKey?MagicBoard.indicators.keyType="ctrlKey":e.shiftKey&&(MagicBoard.indicators.keyType="shiftKey"),t){case 8:case 46:if(MagicBoard.indicators.hilight){var i=MagicBoard.indicators.hilight;i.click(),i.deleteShape()}case 90:case 122:"ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.sheetBook.currentSheet.undo();default:return}},MagicBoard.getPos=function(e){var t,i,r=0,o=0;return e.pageX||e.pageY?(t=e.pageX-document.body.scrollTop,i=e.pageY-document.body.scrollTop):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t-r-MagicBoard.boardPos.x,y:i-o-MagicBoard.boardPos.y}};var Utility={Shape:{},Sheet:{},SheetBook:{}};Utility.SheetBook.clearScratchCanvas=function(){var e=MagicBoard.sheetBook.scratchCtx,t=MagicBoard.sheetBook.scratchCanvas;e.clearRect(0,0,t.width,t.height)},Utility.SheetBook.createWorkItems=function(e){e.connectCanvas=document.createElement("canvas"),e.connectCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),this.connectCtx=null,e.connectCanvas.setAttribute("name","workItem"),e.connectCanvas.height=e.cheight,e.connectCanvas.width=e.cwidth,e.connectCtx=e.connectCanvas.getContext("2d"),e.connectCtx.translate(.5,.5),e.scratchCanvas=document.createElement("canvas"),e.scratchCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),e.scratchCtx=null,e.scratchCanvas.setAttribute("name","workItem"),e.scratchCanvas.height=e.cheight,e.scratchCanvas.width=e.cwidth,e.scratchCtx=e.scratchCanvas.getContext("2d"),e.scratchCtx.translate(.5,.5),e.hilighter=document.createElement("div"),e.hilighter.setAttribute("style","visibility:hidden;height:100px;width:100px;left:0px;top:0px;z-index:10"),e.hilighter.setAttribute("class","hilight"),e.hilighter.setAttribute("name","workItem"),e.hilighter.onmouseover=function(){MagicBoard.indicators.hilight&&MagicBoard.indicators.mouseover.push(MagicBoard.indicators.hilight)},e.hilighter.onmouseout=function(){event.preventDefault(),MagicBoard.indicators.mouseover=[]},e.hilighter.innerHTML="<div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher name='workItem''><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div>";var t=e.hilighter.children,i=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=-1)};t[0].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=0)},t[0].onmouseout=i,t[1].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=1)},t[1].onmouseout=i,t[2].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=2)},t[2].onmouseout=i,t[3].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=3)},t[3].onmouseout=i,t[4].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=4)},t[4].onmouseout=i,t[5].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=5)},t[5].onmouseout=i,t[6].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=6)},t[6].onmouseout=i,t[7].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=7)},t[7].onmouseout=i,e.textEditor=document.createElement("div"),e.textEditor.setAttribute("contenteditable","true"),e.textEditor.setAttribute("style","position:absolute;left:0px;top:0px;width:10px;height:14px;display:none;background:white;z-index:100"),document.body.appendChild(e.textEditor),e.textEditor.onblur=function(){e.textEditor.style.display="none";var t=e.textEditor.targetShape;t.updateText(e.textEditor.innerHTML),t.selectToggle(),e.textEditor.targetShape=null},e.star=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.star.setAttribute("style","display:none;position:absolute;left:0px;top:0px;z-index:10;width:50px;height:21px"),e.star.innerHTML='<polygon points="10,1 4,20 19,8 1,8 16,20" style="fill:red;stroke:red;stroke-width:1;fill-rule:nonzero;" />',e.star.onclick=function(){var t=e.star.cLine;t&&t.click()},Utility.SheetBook.attachWorkItems(e)},Utility.SheetBook.attachWorkItems=function(e){sheetCanvas=e.anchor,sheetCanvas.appendChild(e.scratchCanvas),sheetCanvas.appendChild(e.connectCanvas),sheetCanvas.appendChild(e.hilighter),sheetCanvas.appendChild(e.star)},Utility.SheetBook.activateHilighter=function(e,t){var i=MagicBoard.sheetBook.hilighter;i.style.visibility="visible",Utility.SheetBook.resizeHilighter(e,t)},Utility.SheetBook.resizeHilighter=function(e,t){var i=MagicBoard.sheetBook.hilighter,r=e.left-4,o=e.top-4,a=e.width+8,n=e.height+8;i.style.left=r+"px",i.style.top=o+"px",i.style.width=a+"px",i.style.height=n+"px";var s=i.children,h=s[0].style;h.left="-12px",h.top=n/2-12+"px",h.cursor="ew-resize";var l=s[1].style;l.left=a-14+"px",l.top=n/2-12+"px",l.cursor="ew-resize";var c=s[2].style;c.left=a/2-12+"px",c.top="-12px",c.cursor="ns-resize";var d=s[3].style;d.left=a/2-12+"px",d.top=n-14+"px",d.cursor="ns-resize";var p=s[4].style;p.left="-12px",p.top="-12px",p.cursor="nw-resize";var m=s[5].style;m.left="-12px",m.top=n-14+"px",m.cursor="sw-resize";var u=s[6].style;u.left=a-12+"px",u.top="-12px",u.cursor="ne-resize";var g=s[7].style;g.left=a-12+"px",g.top=n-14+"px",g.cursor="nw-resize"},Utility.Sheet.Markers=function(e){var t="<defs><marker id='fillArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='rgb(27,141,17)'></path></marker><marker id='fillArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='rgb(27,141,17)'></path></marker><marker id='hollowArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='fillDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='rgb(27,141,17)' ></path></marker><marker id='dot' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><circle r='3' cx='3' cy='3' fill='rgb(27,141,17)' ></circle></marker><marker id='lineArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L9,3 L0,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='lineArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M9,0 L0,3 L9,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker></defs>";e.canvas.innerHTML=t},Utility.Sheet.isGridAvailable=function(e,t,i){var r=i.dimension,o=t.courseGrids,a=o.length,n=t.noOfXcourseGrids,s=(t.noOfYcourseGrids,10),h=MagicBoard.sheetBook.cwidth,l=MagicBoard.sheetBook.cheight;if(-1===e){var c=0,d=0;r.left&&(c=r.left),e=Utility.Sheet.LeftAlignedFreeGrid(c,d,t);for(var p=e;a>p;p++){var m=o[p];if(!m.filled)return Utility.Sheet.isGridAvailable(p,t,i)}}var u=o[e],g=u.x1+s,v=u.y1+s,f={x:g,y:v},y={x:g+r.width,y:v};if(y.x>h)return Utility.Sheet.isGridAvailable(e+1,t,i);var k={x:g,y:v+r.height};if(k.y>l)return[];for(var B=({x:g+r.width,y:v+r.height},Math.floor(e/n)+1,[]),x=e;a>x;x++){var S,w,b,M,m=o[x];if(S=m.x1,w=m.x2,b=m.y1,M=m.y2,!(w<f.x||S>y.x)){if(b>k.y)break;if(!(M<f.y)){if(m.filled){for(var C=x;a>C;C++){if(C>=a)return[];if(!o[C].filled)break}var T=Utility.Sheet.isGridAvailable(C,t,i);if(T.length>0)return T}B.push(x)}}}return B},Utility.Sheet.LeftAlignedFreeGrid=function(e,t,i){var r=i.noOfXcourseGrids,o=i.courseGrids;return startGridSeq=Math.floor(t/i.courseGridSize.y)*r+Math.floor(e/i.courseGridSize.x),startGridSeq>o.length?0:o[startGridSeq].filled?e?Utility.Sheet.LeftAlignedFreeGrid(e,t+i.courseGridSize.y,i):startGridSeq++:startGridSeq},Utility.Sheet.findOwner=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,r=0;i>r;r++){var o=t.shapes[r];if(o.dom===e)return o.dom;for(var a=o.components.length,n=0;a>n;n++){var s=o.components[n];if(s.dom===e)return s}}return null},Utility.Sheet.connectIds=function(){for(var e=MagicBoard.sheetBook.currentSheet,t=e.shapes.length,i=0;t>i;i++){var r=e.shapes[i];if(r.connectedFromIds)for(var o=0,a=r.connectedFromIds.length;a>o;o++){var n=r.connectedFromIds[o];r.connectedFrom.push(Utility.Sheet.findShapeById(n))}if(r.connectedToIds)for(var o=0,a=r.connectedToIds.length;a>o;o++){var s=r.connectedToIds[o];r.connectedTo.push(Utility.Sheet.findShapeById(s))}}for(var i=0;t>i;i++){var r=e.shapes[i];r.refreshConnection()}},Utility.Sheet.findShapeById=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,r=0;i>r;r++){var o=t.shapes[r];if(o.id===e)return o}},Utility.Shape.resize=function(e,t,i){e.dimension.resizeX||(e.dimension.resizeX=e.dimension.left),e.dimension.resizeY||(e.dimension.resizeY=e.dimension.top);var r=e.dimension.resizeX,o=e.dimension.resizeY,a=!1,n=MagicBoard.indicators.resize;if(2>n){e.dimension.resizeWidth||(e.dimension.resizeWidth=e.dimension.width);var s=e.dimension.resizeWidth,h=s;0===MagicBoard.indicators.resize?(r+=t,h=s-t,a=!0):h=s+t,e.dimension.width=h,e.dom.setAttribute("width",h)}else if(4>n){e.dimension.resizeHeight||(e.dimension.resizeHeight=e.dimension.height);var l=e.dimension.resizeHeight,c=l;2===MagicBoard.indicators.resize?(o+=i,c=l-i,a=!0):c=l+i,e.dimension.height=c,e.dom.setAttribute("height",c)}else{e.dimension.resizeWidth||(e.dimension.resizeWidth=e.dimension.width);var s=e.dimension.resizeWidth,h=s;e.dimension.resizeHeight||(e.dimension.resizeHeight=e.dimension.height);var l=e.dimension.resizeHeight,c=l;4===n?(r+=t,h=s-t,o+=i,c=l-i,a=!0):5===n?(r+=t,h=s-t,c=l+i,a=!0):6===n?(h=s+t,o+=i,c=l-i,a=!0):7===n&&(h=s+t,c=l+i),e.dimension.width=h,e.dom.setAttribute("width",h),e.dimension.height=c,e.dom.setAttribute("height",c)}a&&e.setPosition({x:r,y:o}),e.reDraw()},Utility.Shape.applyProperty=function(){var e=document.getElementById("propPrompt"),t=e.shape;e.shape=null;for(var i=e.getElementsByClassName("prop"),r=i.length,o=0;r>o;o++){var a=i[o],n=a.getAttribute("data-dirty");if(n&&"1"===n){var s,h=a.getAttribute("data-propKey"),l=a.getAttribute("data-propType"),c=a.getAttribute("data-propName");"INPUT"===a.nodeName?s=a.value:"SELECT"===a.nodeName&&(s=a.options[a.selectedIndex].value),t.applyProperty(h,c,l,s)}}Utility.destroyDom(e,"dom")},Utility.addChangeFlag=function(){var e=event.target;e.setAttribute("data-dirty","1")},Utility.Shape.showProperty=function(){var e="",t=MagicBoard.indicators.hilight,i=t.properties;i.length;for(var r in i){var o=MagicBoard.properties[r];if("input"===o.field)e+="<label class='propLabel'>"+o.label+":</label><input class='propInput prop' data-propKey='"+r+"' class='prop' data-propType='"+o.propType+"'  data-propName='"+o.propName+"' type='"+o.values[0].type+"' value='"+o.values[0].value+"' onchange='Utility.addChangeFlag()'/><BR/>";else if("select"===o.field){e+="<label class='propLabel' >"+o.label+":</label><select onchange='Utility.addChangeFlag()' data-propKey='"+r+"' class='prop' data-propType='"+o.propType+"'  data-propName='"+o.propName+"'  >";for(var a=0,n=o.values.length;n>a;a++)e+="<option value='"+o.values[a].value+"' >"+o.values[a].name+"</option>";e+="</select><BR/>"}}if(e){e+="<br/><button class='apply button' onclick='Utility.Shape.applyProperty()'>Apply</button><button class='cancel button' onclick='Utility.destroyDom(\"propPrompt\",\"id\")'>Cancel</button>";var s=document.createElement("div");s.setAttribute("class","prompt"),s.setAttribute("style",""),s.setAttribute("id","propPrompt"),s.innerHTML=e,s.shape=t,document.body.appendChild(s)}},Utility.Shape.align=function(e){var t=MagicBoard.sheetBook.alignments.x,i=MagicBoard.sheetBook.alignments.y,r=9999,o=9999,a=e.x;nearestY=e.y;for(var n in t)if(t[n]&&t[n].length>0){var s=Math.abs(e.y-n);o>s&&(o=s,nearestY=n)}for(var h in i)if(i[h]&&i[h].length>0){var s=Math.abs(e.x-h);r>s&&(r=s,a=h)}return Math.abs(e.x-a)<20&&("string"==typeof a&&(a=parseInt(a)),e.x=a),Math.abs(e.y-nearestY)<20&&("string"==typeof nearestY&&(nearestY=parseInt(nearestY)),e.y=nearestY),e},Utility.Sheet.drawCourseGrid=function(e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height),t.setLineDash([1,15]),t.beginPath();for(var r=0,o=0;o<e.noOfYcourseGrids;o++){var a=o*e.courseGridSize.y;t.moveTo(0,a),t.lineTo(MagicBoard.sheetBook.cwidth,a);for(var n=0;n<e.noOfXcourseGrids;n++){var s=n*e.courseGridSize.x;t.moveTo(s,0),t.lineTo(s,MagicBoard.sheetBook.cheight);var h="Filled "+r,l=e.courseGrids[r++];l.filled&&t.fillText(h,s+20,a+20)}}t.stroke()},Utility.Shape.blockGrids=function(e){var t=e.currentSheet,i=e.dimension,r=t.courseGrids;Utility.Shape.unblockGrids(e,r);for(var o=i.left,a=i.top,n=Math.floor(o/t.courseGridSize.x),s=Math.floor(a/t.courseGridSize.y),h=s*t.noOfXcourseGrids+n,l={x:o,y:a},c={x:o+i.width,y:a},d={x:o,y:a+i.height},r=({x:o+i.width,y:a+i.height},t.courseGrids),p=r.length,m=h;p>m;m++){var u,g,v,f,y=r[m];if(u=y.x1,g=y.x2,v=y.y1,f=y.y2,!(g<l.x||u>c.x)){if(v>d.y)break;f<l.y||(y.filled=!0,y.shapes.push(e),e.occupiedGrids.push(m))}}},Utility.Shape.unblockGrids=function(e,t){for(var i=e.occupiedGrids,r=i.length,o=0;r>o;o++){for(var a=i[o],n=t[a],s=n.shapes,h=s.length,l=0;h>l;l++){var c=s[l];if(c===e){s.splice(l,1);break}}0===s.length&&(n.filled=!1)}e.occupiedGrids=[]},Utility.Shape.defineConnectionCoordinates=function(e,t){var i,r,o,a,n,s,h,l,c=0,d=t.pos,h=d.x1,l=d.y1,p=h,m=l,u=d.x2,g=d.y2;h>u&&(p=u),l>g&&(m=g),p-=10,m-=10;var v=Math.abs(d.x2-d.x1)+20,f=Math.abs(d.y2-d.y1)+20;e.frame={width:v,height:f,unit:"px",left:p,top:m};var y=(d.x1+d.x2)/2,k=(d.y1+d.y2)/2,B=[],x=[];B.push({op:"M",x:d.x1,y:d.y1}),x.push({op:"M",x:100*(d.x1-p)/v,y:100*(d.y1-m)/f});var S=t.connProp;return"DIRECT"===S.type?(i=Drawing.getLineAngle(h,l,u,g),r=Drawing.getLineAngle(u,g,h,l)):"TWOBEND"===S.type&&("vert"===t.orientation?(B.push({op:"L",x:d.x1,y:k}),B.push({op:"L",x:u,y:k}),i=Drawing.getLineAngle(h,l,h,k),r=Drawing.getLineAngle(u,g,u,k),x.push({op:"L",x:100*(d.x1-p)/v,y:100*(k-m)/f}),x.push({op:"L",x:100*(u-p)/v,y:100*(k-m)/f}),g>d.y1?(g-=c,n=l+c,s=g-c):(g+=c,n=l-c,s=g+c),o=h,a=u):"horizvert"===t.orientation?(B.push({op:"L",x:d.x2,y:d.y1}),i=Drawing.getLineAngle(h,l,d.x2,d.y1),r=Drawing.getLineAngle(u,g,d.x2,d.y1),x.push({op:"L",x:100*(d.x2-p)/v,y:100*(d.y1-m)/f}),g>d.y1?(g-=c,n=l,s=g-c):(g+=c,n=l,s=g+c),u>d.x1?(o=h+c,a=u):(o=h-c,a=u)):(B.push({op:"L",x:y,y:d.y1}),B.push({op:"L",x:y,y:g}),i=Drawing.getLineAngle(h,l,y,d.y1),r=Drawing.getLineAngle(u,g,y,g),x.push({op:"L",x:100*(y-p)/v,y:100*(d.y1-m)/f}),x.push({op:"L",x:100*(y-p)/v,y:100*(g-m)/f}),u>d.x1?(u-=c,o=h+c,a=u-c):(u+=c,o=h-c,a=u+c),n=l,s=g)),e.cInfo.angleStart=i,e.cInfo.angleEnd=r,e.cx1=o,e.cx2=a,e.cy1=n,e.cy2=s,B.push({op:"L",x:u,y:g}),x.push({op:"L",x:100*(u-p)/v,y:100*(g-m)/f}),{d:x,lines:B}},Utility.Shape.calculateConnectionPoints=function(e,t,i){var r,o,a,n,s=e.getDimension(),h=t.getDimension(),l=s.edgePoints,c=h.edgePoints,d="horiz";if(l.c1.x>c.c2.x){var p=l.m41.x-c.m23.x;if(p>50)r=l.m41.x,a=l.m41.y,o=c.m23.x,n=c.m23.y;else{var m=l.m41.y-c.m23.y,u=(l.m12.x-c.m23.x,l.m12.y-c.m23.y),g=(l.m12.x-c.m23.x,l.m12.y-c.m23.y);if(u>50)l.m12.x-c.m34.x>50?(r=l.m12.x,a=l.m12.y,o=c.m34.x,n=c.m34.y,d="vert"):(r=l.m12.x,a=l.m12.y,o=c.m23.x,n=c.m23.y,d="horizvert");else if(g>50)r=l.m34.x,a=l.m34.y,o=c.m23.x,n=c.m23.y,d="horizvert";else if(m>50){var v=l.m41.y-c.m34.y;v>50?(r=l.m41.x,a=l.m41.y,o=c.m34.x,n=c.m34.y):(r=l.m41.x,a=l.m41.y,o=c.m23.x,n=c.m23.y)}else r=l.m41.x,a=l.m41.y,o=c.m23.x,n=c.m23.y}}else if(l.c2.x<c.c1.x){var f=l.m41.x-c.m23.x;if(f>50)r=l.m23.x,a=l.m23.y,o=c.m41.x,n=c.m41.y;else{var y=(l.m23.y-c.m41.y,l.m23.x-c.m12.x,l.m23.y-c.m12.y),k=(l.m23.x-c.m34.x,l.m23.y-c.m34.y);Math.abs(k)>50?(r=l.m23.x,a=l.m23.y,k>0?(o=c.m34.x,n=c.m34.y):(o=c.m12.x,n=c.m12.y),d="horizvert"):y>50?c.m41.x-l.m23.x>50?(r=l.m23.x,a=l.m23.y,o=c.m41.x,n=c.m41.y):(r=l.m23.x,a=l.m23.y,o=c.m12.x,n=c.m12.y,d="horizvert"):(r=l.m23.x,a=l.m23.y,o=c.m41.x,n=c.m41.y)}}else l.c1.y>c.c3.y?(r=l.m12.x,a=l.m12.y,o=c.m34.x,n=c.m34.y,d="vert"):(r=l.m34.x,a=l.m34.y,o=c.m12.x,n=c.m12.y,d="vert");return{beginShape:e,endShape:t,pos:{x1:r,x2:o,y1:a,y2:n},orientation:d,connProp:i}},Utility.Sheet.removeConnection=function(e,t,i){for(var r=e.connections,o=r.length,a=0;o>a;a++){var n=r[a];if(n.beginShape===t&&n.endShape===i)return r.splice(a,1),void n.shape.deleteShape()}},Utility.Shape.dataFormatter=function(e,t,i){if(void 0==e)return 0;if("number"==typeof e)return e;if("string"==typeof e){if(e.indexOf("px")>-1)return parseInt(e.replace("px",""));if(e.indexOf("%")>-1){if(!i)return console.log(" In order to calculate %, we need the shape, that is missing in the call"),0;var r=parseInt(e.replace("%","")),o=null;if(i.parentShape)o=i.parentShape.dimension;else{var a=MagicBoard.sheetBook;o={left:0,top:0,width:a.cwidth,height:a.cheight}}var n=t;return"left"===t?n="width":"top"===t&&(n="height"),o[n]*r/100}}},Utility.Shape.recalculateDimensions=function(e){var t=e.dimension;if(t.misc.unit&&"%"===t.misc.unit)for(var i=t.misc.key,r=i.length,o=0;r>o;o++){var a=i[o],n=e.style[a],s=Utility.Shape.dataFormatter(n,a,e);t[a]=s}},Utility.destroyDom=function(e,t){var i=MagicBoard.sheetBook.garbage,r=null;"id"===t?r=document.getElementById(e):"dom"===t&&(r=e),i.appendChild(r),i.innerHTML=""};var Logger=function(){},Info=function(){};inheritsFrom(Info,Logger),Info.prototype.console=function(e){console.log("Info - "+e)};var Warning=function(){};inheritsFrom(Warning,Logger),Warning.prototype.console=function(e){console.log("Warning - "+e)};var Error=function(){};inheritsFrom(Error,Logger),Error.prototype.console=function(e){Error.log("Error - "+e)};var info=new Info,warning=new Warning,error=new Error;