/*!
 * Magic Board v1
 * Copyright 2015-2016 BinaryCodon, Inc.
 * Licensed under GNU Affero General Public License
 * Author - Rajeev Shrivastava
 */
var inheritsFrom=function(e,t){e.prototype=Object.create(t.prototype)},MagicBoard={sheetBook:null,indicators:{mouseDown:!1,mouseover:[],click:!1,doubleClick:0,resize:-1},boardPos:{x:0,y:0}};MagicBoard.properties={"background-color":{propType:"attribute",propName:"fill",label:"Background Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"border-color":{propName:"stroke",propType:"attribute",label:"Border Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"border-width":{propName:"stroke-width",propType:"attribute",label:"Border Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"border-style":{propName:"stroke-dasharray",propType:"attribute",label:"Border Style",field:"select",values:[{name:"Dash",value:"5,5",type:""},{name:"Solid",value:"",type:""},{name:"Dotted",value:"1,1",type:""}]},"text-color":{propName:"fill",propType:"attribute",label:"Text Color",field:"input",values:[{name:"",value:"#ffffff",type:"color"}]},"font-size":{propName:"font-size",propType:"attribute",label:"Font Color",field:"input",values:[{name:"",value:"14",type:"text"}]},"font-weight":{propName:"font-weight",propType:"attribute",label:"Font Weight",field:"select",values:[{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"}]},"text-content":{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{value:""}]},"line-type":{propName:"",propType:"function",field:"select",label:"Line Type",values:[{name:"Straight",value:"straight"},{name:"Zig Zag",value:"zig-zag"},{name:"Brezier Curve",value:"brezier"},{name:"Quadratic Curve",value:"quadratic"}]},"line-color":{propName:"stroke",propType:"attribute",label:"Line Color",field:"input",values:[{name:"",value:"#1b8d11",type:"color"}]},"line-width":{propName:"stroke-width",propType:"attribute",label:"Line Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"line-style":{propName:"stroke-dasharray",propType:"attribute",label:"Line Style",field:"select",values:[{name:"Solid",value:"",type:""},{name:"Dash",value:"5,5",type:""},{name:"Dotted",value:"1,1",type:""}]},"end-marker":{propName:"marker-end",propType:"attribute",label:"End Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowE)"},{name:"Hollow Arrow",value:"url(#hollowArrowE)"},{name:"Regular Arrow",value:"url(#lineArrowE)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"start-marker":{propName:"marker-start",propType:"attribute",label:"Start Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowS)"},{name:"Hollow Arrow",value:"url(#hollowArrowS)"},{name:"Regular Arrow",value:"url(#lineArrowS)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"mid-marker":{propName:"marker-mid",propType:"attribute",field:"select",label:"Mid Marker",values:[{name:"Dot",value:"url(#dot)"}]}};var SheetBook=function(e,t,i){this.cheight=400,this.cwidth=400,this.sheets=[],this.currentSheet=null,this.anchor=document.body,this.alignments={x:[],y:[]},this.maxRedo=5,this.garbage=document.createElement("div"),this.garbage.setAttribute("style","display:none"),document.body.appendChild(this.garbage),i&&(this.cheight=i),t&&(this.cwidth=t),e&&(this.anchor=e);var o=e.getBoundingClientRect();MagicBoard.boardPos={x:o.left,y:o.top},Utility.SheetBook.createWorkItems(this),document.onmousedown=function(e){return MagicBoard.eventStart(e)},document.onmousemove=function(e){MagicBoard.eventContinue(e)},document.onmouseup=function(e){MagicBoard.eventStop(e)},document.onkeyup=function(e){event.preventDefault(),MagicBoard.keyUp(e)}};SheetBook.prototype.zoom=function(){},SheetBook.prototype.setAnchorElement=function(e){this.anchor=e},SheetBook.prototype.addSheet=function(e){this.sheets.push(e);var t=e.getCanvas();t.setAttribute("height",this.cheight),t.setAttribute("width",this.cwidth),t.style.width=this.cwidth+"px",t.style.height=this.cheight+"px",this.anchor.appendChild(t),this.setCurrentSheet(e)},SheetBook.prototype.getSheet=function(e){for(var t=this.sheets.length-1;t>-1;t--){var i=this.sheets[t];if(i.name===e)return i}return null},SheetBook.prototype.getCurrentSheet=function(){return this.currentSheet},SheetBook.prototype.setCurrentSheet=function(e){var t=this.currentSheet;t&&(t.canvas.style.visibility="hidden");var i=null,o=!1;"string"==typeof e&&(i=e,o=!0);for(var r=this.sheets.length-1;r>-1;r--){var a=this.sheets[r];if(o){if(a.name===i)break}else if(a===e)break}this.currentSheet=e,e.canvas.style.visibility="visible";var n=this.connectCanvas;MagicBoard.sheetBook.connectCtx.clearRect(0,0,n.width,n.height)},SheetBook.prototype.getCombinedImage=function(){var e=this.scratchCtx;if(e){e.clearRect(0,0,this.cwidth,this.cheight);for(var t=this.shapes.length,i=0;t>i;i++){var o=this.shapes[i];o.draw(e)}var r=this.scratchCanvas.toDataURL();return r}},SheetBook.prototype.setHeight=function(e){this.cheight=e,this.currentCanvas.setAttribute("height",this.cheight)},SheetBook.prototype.setWidth=function(e){this.cwidth=e,this.currentCanvas.setAttribute("width",e)};var Sheet=function(e){this.options={},e&&(this.options=e),this.name="Sheet1",e.name&&(this.name=e.name),this.canvas=null,this.init()};Sheet.prototype.init=function(){this.shapes=[],this.removedShapes=[],this.canvas=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.canvas.setAttribute("id",this.name),this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px",this.canvas.style["z-index"]="1",this.canvas.style.visibility="visible";var e=this.options["background-color"];e&&(this.canvas.style.fill=e),this.connections=[],Utility.Sheet.Markers(this),this.courseGridSize={x:100,y:100},this.noOfXcourseGrids=Math.floor(MagicBoard.sheetBook.cwidth/this.courseGridSize.x),this.noOfYcourseGrids=Math.floor(MagicBoard.sheetBook.cheight/this.courseGridSize.y),this.courseGrids=[];for(var t=0,i=0;i<this.noOfYcourseGrids;i++)for(var o=i*this.courseGridSize.y,r=(i+1)*this.courseGridSize.y,a=0;a<this.noOfXcourseGrids;a++){var n=a*this.courseGridSize.x,s=(a+1)*this.courseGridSize.x,h={filled:!1,shapes:[],x1:n,x2:s,y1:o,y2:r,index:t++};this.courseGrids.push(h)}},Sheet.prototype.getCanvas=function(){return this.canvas},Sheet.prototype.wipe=function(){for(var e=MagicBoard.sheetBook.garbage,t=this.canvas.children,i=t.length-1;i>-1;i--){var o=t[i];"workItem"!==o.getAttribute("name")&&e.appendChild(o)}e.innerHTML=""},Sheet.prototype.totalShapeArea=function(){},Sheet.prototype.addShape=function(e){this.shapes.push(e)},Sheet.prototype.removeLastShape=function(){var e=MagicBoard.sheetBook.maxRedo;if(0!==this.shapes.length){var t=this.shapes[this.shapes.length-1];this.removedShapes.push(t),this.removedShapes.length>e&&this.removedShapes.splice(0,1),this.shapes.pop()}},Sheet.prototype.removeShape=function(e){if(0!==this.shapes.length)for(var t=this.shapes.length-1;t>-1;t--){var i=this.shapes[t];if(i===e)return void this.shapes.splice(t,1)}},Sheet.prototype.reDraw=function(){this.wipe();for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.createCanvas(),i.draw()}},Sheet.prototype.undo=function(){this.removeLastShape(),this.reDraw()},Sheet.prototype.redo=function(){0!==this.removedShapes.length&&(this.shapes.push(this.removedShapes[0]),this.removedShapes.splice(0,1),this.reDraw())},Sheet.prototype.refreshConnections=function(){for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.refreshConnection()}},Sheet.prototype.getImage=function(){var e=document.createElement("canvas");e.height=MagicBoard.sheetBook.cheight,e.width=MagicBoard.sheetBook.cwidth;for(var t=e.getContext("2d"),i=this.shapes,o=i.length,r=0;o>r;r++){var a=i[r];a.drawOnCanvas(t)}var n=e.toDataURL();return n},Sheet.prototype.addConnections=function(e){for(var t=e.beginShape,i=e.endShape,o=e.pos,r=this.connections,a=r.length,n=!1,s=0;a>s;s++){var h=r[s],o=e.pos;if(h.beginShape===t&&h.endShape===i)return n=!0,h.pos=o,h.orientation=e.orientation,h}return n||r.push(e),e},Sheet.prototype.removeConnections=function(e){for(var t=e.connectedFrom,i=(t.length,0);a>i;i++){var o=t[i];Utility.Sheet.removeConnection(this,o,e)}for(var r=e.connectedTo,a=r.length,n=0;a>n;n++){var s=r[n];Utility.Sheet.removeConnection(this,e,s)}},Sheet.prototype.drawConnections=function(e){if(!e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height)}for(var o=this.connections,r=o.length,a=0;r>a;a++){var n=o[a];n.shape&&(n.shape.deleteShape(),n.shape=null);var s=new ConnectorLine(n);s.draw()}};var Point=function(e,t){this.x=e,this.y=t},Drawing={};Drawing.getLineAngle=function(e,t,i,o){return Math.atan2(t-o,e-i)},Drawing.getArrowHead=function(e,t,i){var o,r,a,n,s=10;return o=e-s*Math.cos(i-Math.PI/6),a=t-s*Math.sin(i-Math.PI/6),r=e-s*Math.cos(i+Math.PI/6),n=t-s*Math.sin(i+Math.PI/6),{x1:o,x2:r,y1:a,y2:n}},Drawing.drawArrow=function(e,t,i,o){var r,a,n,s,h=10;return r=t-h*Math.cos(o-Math.PI/6),n=i-h*Math.sin(o-Math.PI/6),a=t-h*Math.cos(o+Math.PI/6),s=i-h*Math.sin(o+Math.PI/6),e.beginPath(),e.moveTo(t,i),e.lineTo(r,n),e.moveTo(t,i),e.lineTo(a,s),e.stroke(),{x1:r,x2:a,y1:n,y2:s}},Drawing.roundRect=function(e,t,i,o,r,a,n,s){if("undefined"==typeof s&&(s=!0),"undefined"==typeof a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var h={tl:0,tr:0,br:0,bl:0};for(var c in h)a[c]=a[c]||h[c]}e.beginPath(),e.moveTo(t+a.tl,i),e.lineTo(t+o-a.tr,i),e.quadraticCurveTo(t+o,i,t+o,i+a.tr),e.lineTo(t+o,i+r-a.br),e.quadraticCurveTo(t+o,i+r,t+o-a.br,i+r),e.lineTo(t+a.bl,i+r),e.quadraticCurveTo(t,i+r,t,i+r-a.bl),e.lineTo(t,i+a.tl),e.quadraticCurveTo(t,i,t+a.tl,i),e.closePath(),n&&e.fill(),s&&e.stroke()};var DrawingObject=function(){this.draw=function(){}},Shape=function(e){this.param=JSON.parse(JSON.stringify(e.param)),this.frame=JSON.parse(JSON.stringify(e.frame)),this.properties={},this.components=[];for(var t=e.componentParms.length,i=0;t>i;i++){var o=new ShapeComponent(e.componentParms[i]);this.components.push(o);for(var r in o.properties)this.properties[r]=!0}this.init()};inheritsFrom(Shape,DrawingObject),Shape.prototype.init=function(){this.children||(this.children=[]),this.components||(this.components=[]),this.param.alignmentRails||(this.param.alignmentRails=!0),this.occupiedGrids=[],this.currentSheet=MagicBoard.sheetBook.getCurrentSheet(),this.sheetCanvas=this.currentSheet.getCanvas(),this.frame&&this.createCanvas();this.dimension=this.frame,this.id=this.currentSheet.shapes.length,this.currentSheet.addShape(this),this.connectedTo=[],this.connectedFrom=[]},Shape.prototype.createCanvas=function(){var e=Utility.Shape.dataFormatter(this.frame.width,"width",this);this.frame.width=e;var t=Utility.Shape.dataFormatter(this.frame.height,"height",this);this.frame.height=t;var i=document.createElementNS("http://www.w3.org/2000/svg","g");this.dom=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("width",e),this.dom.setAttribute("height",t),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("style","position:absolute;-ms-user-select:none;-webkit-user-select:none;z-index:10;transform:translate(1.5,1.5);z-index:1"),this.dom.setAttribute("x",Utility.Shape.dataFormatter(this.frame.left,"left",this)),this.dom.setAttribute("y",Utility.Shape.dataFormatter(this.frame.top,"top",this)),i.appendChild(this.dom),this.sheetCanvas.appendChild(i)},Shape.prototype.addComponent=function(e){this.components.push(e)},Shape.prototype.addHover=function(){var e=this,t=this.dom;t.onmouseover=function(){MagicBoard.indicators.mouseover.push(e)},t.onmouseout=function(){event.preventDefault();for(var t=MagicBoard.indicators.mouseover.length-1;t>-1;t--)if(MagicBoard.indicators.mouseover[t]===e)return void MagicBoard.indicators.mouseover.splice(t,1)}},Shape.prototype.click=function(){this.selectToggle()},Shape.prototype.doubleClick=function(){var e=this,t=event.target;if(t instanceof SVGTextElement){var i=t.getBoundingClientRect(),o=MagicBoard.sheetBook.textEditor;o.style.left=i.left-2,o.style.top=i.top-2,o.style.width=i.width+4,o.style.height=i.height+4,o.style.display="block",o.innerHTML=t.innerHTML,o.targetShape=e,o.focus()}},Shape.prototype.move=function(e,t){var i=this.getDimension(),o=e.y-t.y,r=e.x-t.x,a=i.top+o,n=i.bottom+o,s=i.left+r,h=i.right+r,c=MagicBoard.sheetBook.scratchCtx,l=MagicBoard.sheetBook.scratchCanvas;c.clearRect(0,0,l.width,l.height),c.beginPath(),c.strokeStyle="green",c.setLineDash([2,2]),c.lineWidth=4,c.rect(s-2,a-2,i.width+4,i.height+4),c.stroke(),this.alignmentCheck(c,l.width,l.height,a,s,n,h)},Shape.prototype.resizeContinue=function(e,t){var i=(this.getDimension(),MagicBoard.sheetBook.hilighter);if(MagicBoard.indicators.resize<2){var o=this.dimension.width,r=e.x-t.x,a=o;a=0===MagicBoard.indicators.resize?o-r:o+r;var n=a/o,s="translateX("+r/2+"px) scaleX("+n+")";this.dom.style.transform=s,i.style.transform=s}else if(MagicBoard.indicators.resize>1){var h=this.dimension.height,c=e.y-t.y,l=h;l=2===MagicBoard.indicators.resize?h-c:h+c;var n=l/h,s="translateY("+c/2+"px) scaleY("+n+")";this.dom.style.transform=s,i.style.transform=s}},Shape.prototype.resizeStop=function(){var e=MagicBoard.indicators.resizeStarted,t=MagicBoard.indicators.click,i={x:this.dimension.left,y:this.dimension.top},o=MagicBoard.sheetBook.hilighter;if(o.style.visibility="hidden",o.style.transform="",this.dom.style.transform="",MagicBoard.indicators.resize<2){var r=this.dimension.width,a=e.x-t.x,n=r;0===MagicBoard.indicators.resize?(n=r-a,i.x=e.x):n=r+a,this.dimension.width=n,this.dom.setAttribute("width",n)}else{var s=this.dimension.height,h=e.y-t.y,c=s;2===MagicBoard.indicators.resize?(c=s-h,i.y=e.y):c=s+h,this.dimension.height=c,this.dom.setAttribute("height",c)}this.setPosition(i),this.reDraw(),MagicBoard.indicators.resize=-1,MagicBoard.indicators.resizeStarted=null,MagicBoard.indicators.hilight=!1},Shape.prototype.lineTo=function(e){var t=this.getDimension(),i=MagicBoard.sheetBook.scratchCtx,o=MagicBoard.sheetBook.scratchCanvas;i.clearRect(0,0,o.width,o.height),i.beginPath(),i.strokeStyle="gray",i.lineWidth=1,i.setLineDash([5,5]),i.moveTo(t.cx,t.cy),i.lineTo(e.x,e.y),i.stroke(),i.setLineDash([5,0]);var r=Drawing.getLineAngle(e.x,e.y,t.left,t.top);Drawing.drawArrow(i,e.x,e.y,r)},Shape.prototype.refreshConnection=function(e){for(var t=this.currentSheet,i=this.connectedFrom,o=i.length,r=0;o>r;r++){var a=i[r],n=Utility.Shape.calculateConnectionPoints(a,this);t.addConnections(n),t.drawConnections(e)}for(var s=this.connectedTo,h=s.length,c=0;h>c;c++){endShape=s[c];var n=Utility.Shape.calculateConnectionPoints(this,endShape);t.addConnections(n),t.drawConnections(e)}},Shape.prototype.connectFrom=function(e){for(var t=this.connectedFrom,i=!1,o=t.length,r=0;o>r;r++){var a=t[r];if(e===a)break}i||this.connectedFrom.push(e)},Shape.prototype.connectTo=function(e){var t=this;this.parentShape&&(t=this.parentShape),e.parentShape&&(e=e.parentShape);for(var i=this.connectedTo,o=!1,r=i.length,a=0;r>a;a++){var n=i[a];if(e===n)break}o||t.connectedTo.push(e),e.connectFrom(t);var s=Utility.Shape.calculateConnectionPoints(t,e),h=MagicBoard.sheetBook.currentSheet;h.addConnections(s),h.drawConnections()},Shape.prototype.alignmentCheck=function(e,t,i,o,r,a,n){e.beginPath(),e.strokeStyle="gray",e.lineWidth=1,e.setLineDash([5,5]),MagicBoard.sheetBook.alignments.x[o]&&(e.moveTo(0,o),e.lineTo(t,o)),MagicBoard.sheetBook.alignments.x[a]&&(e.moveTo(0,a),e.lineTo(t,a)),MagicBoard.sheetBook.alignments.y[r]&&(e.moveTo(r,0),e.lineTo(r,i)),MagicBoard.sheetBook.alignments.y[n]&&(e.moveTo(n,0),e.lineTo(n,i)),e.stroke(),e.setLineDash([5,0])},Shape.prototype.setPosition=function(e,t){this.param.alignmentRails&&this.removeAlignments();var i=this.frame;t?(e=Utility.Shape.align(e),this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y)):(this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y)),i.left=e.x,i.top=e.y,i.right=i.left+i.width,i.bottom=i.top+i.height,i.cx=i.left+i.width/2,i.cy=i.top+i.height/2;var o={c1:{x:i.left,y:i.top},c2:{x:i.right,y:i.top},c3:{x:i.right,y:i.bottom},c4:{x:i.left,y:i.bottom},m12:{x:i.cx,y:i.top},m23:{x:i.right,y:i.cy},m34:{x:i.cx,y:i.bottom},m41:{x:i.left,y:i.cy}};i.edgePoints=o,this.refreshConnection(),this.param.alignmentRails&&this.addAlignments(),this.param.noGridBlock||Utility.Shape.blockGrids(this)},Shape.prototype.setDimension=function(e){this.dimension={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.width,height:e.height},this.addAlignments()},Shape.prototype.removeAlignments=function(){var e=function(e,t){if(!e)return!1;var i=e.length;if(2>i)return!1;for(var o=i-1;o>-1;o--){var r=e[o];if(r===t)return void e.splice(o,1)}},t=this.dimension,i=e(MagicBoard.sheetBook.alignments.y[t.left],this);i||(MagicBoard.sheetBook.alignments.y[t.left]=null),i=e(MagicBoard.sheetBook.alignments.y[t.right],this),i||(MagicBoard.sheetBook.alignments.y[t.right]=null),i=e(MagicBoard.sheetBook.alignments.y[t.cx],this),i||(MagicBoard.sheetBook.alignments.y[t.cx]=null),i=e(MagicBoard.sheetBook.alignments.x[t.top],this),i||(MagicBoard.sheetBook.alignments.x[t.top]=null),i=e(MagicBoard.sheetBook.alignments.x[t.bottom],this),i||(MagicBoard.sheetBook.alignments.x[t.bottom]=null),i=e(MagicBoard.sheetBook.alignments.x[t.cy],this),i||(MagicBoard.sheetBook.alignments.x[t.cy]=null)},Shape.prototype.addAlignments=function(){var e=this.dimension;MagicBoard.sheetBook.alignments.y[e.left]||(MagicBoard.sheetBook.alignments.y[e.left]=[]),MagicBoard.sheetBook.alignments.y[e.left].push(this),MagicBoard.sheetBook.alignments.y[e.right]||(MagicBoard.sheetBook.alignments.y[e.right]=[]),MagicBoard.sheetBook.alignments.y[e.right].push(this),MagicBoard.sheetBook.alignments.y[e.cx]||(MagicBoard.sheetBook.alignments.y[e.cx]=[]),MagicBoard.sheetBook.alignments.y[e.cx].push(this),MagicBoard.sheetBook.alignments.x[e.top]||(MagicBoard.sheetBook.alignments.x[e.top]=[]),MagicBoard.sheetBook.alignments.x[e.top].push(this),MagicBoard.sheetBook.alignments.x[e.bottom]||(MagicBoard.sheetBook.alignments.x[e.bottom]=[]),MagicBoard.sheetBook.alignments.x[e.bottom].push(this),MagicBoard.sheetBook.alignments.x[e.cy]||(MagicBoard.sheetBook.alignments.x[e.cy]=[]),MagicBoard.sheetBook.alignments.x[e.cy].push(this)},Shape.prototype.getDimension=function(){return this.dimension||this.setDimension(this.dom.getBoundingClientRect()),this.dimension},Shape.prototype.applyProperty=function(e,t,i,o){for(var r=0,a=this.components.length;a>r;r++){var n=this.components[r];n.properties[e]&&n.applyProperty(t,i,o)}},Shape.prototype.getDom=function(){return this.dom},Shape.prototype.setPoints=function(e){this.points=e},Shape.prototype.getArea=function(){},Shape.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage;e.appendChild(this.dom),e.innerHTML="";for(var t in this)if("object"==typeof this[t]){if("connectedTo"===t){{this.connectedTo}MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections()}else"connectedFrom"===t&&(MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections());this[t]=null}},Shape.prototype.selectToggle=function(){var e=this.getDimension(),t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height);var o=MagicBoard.sheetBook.hilighter;if(MagicBoard.indicators.hilight)o.style.visibility="hidden",setTimeout(function(){MagicBoard.indicators.hilight=!1},100),this.addAlignments();else{for(var r=e.left,a=e.top,n=this.parentShape;n;)r+=n.dimension.left,a+=n.dimension.top,n=n.parentShape;Utility.SheetBook.activateHilighter({left:r,top:a,width:e.width,height:e.height}),MagicBoard.indicators.hilight=this,this.removeAlignments()}},Shape.prototype.updateText=function(e,t){void 0==t&&(t=0);for(var i=0,o=0,r=this.components.length;r>o;o++){var a=this.components[o];if("text"===a.type){if(i===t){a.updateText(e);break}i++}}},Shape.prototype.draw=function(){var e=this.dom;e.innerHTML="";var t=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(t),this.reDraw(t);for(var i=this.components.length,o=0;i>o;o++){var r=this.components[o];r.parentShape=this;var a=r.construct();a&&t.appendChild(a)}},Shape.prototype.reDraw=function(e){var t=!0;e||(e=this.dom.firstElementChlid,t=!1);for(var i=this.components.length,o=0;i>o;o++){var r=this.components[o];r.parentShape=this;var a=r.construct();t&&a&&e.appendChild(a)}this.refreshConnection()},Shape.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var o=this.components[i];o.drawOnCanvas(e)}e.stroke(),this.refreshConnection(e)};var ConnectorLine=function(e){var t=0,i=this,o=e.pos,r=o.x1,a=o.y1,n=r,s=a,h=o.x2,c=o.y2;r>h&&(n=h),a>c&&(s=c),n-=10,s-=10;var l=Math.abs(o.x2-o.x1)+20,d=Math.abs(o.y2-o.y1)+20;this.frame={width:l,height:d,unit:"px",left:n,top:s};var p=(o.x1+o.x2)/2,m=(o.y1+o.y2)/2,u=[],g=[];u.push({op:"M",x:o.x1,y:o.y1}),g.push({op:"M",x:100*(o.x1-n)/l,y:100*(o.y1-s)/d});var v,y,f,x,r,a;this.cInfo=e,"vert"===e.orientation?(u.push({op:"L",x:o.x1,y:m}),u.push({op:"L",x:h,y:m}),g.push({op:"L",x:100*(o.x1-n)/l,y:100*(m-s)/d}),g.push({op:"L",x:100*(h-n)/l,y:100*(m-s)/d}),c>o.y1?(c-=t,f=a+t,x=c-t):(c+=t,f=a-t,x=c+t),v=r,y=h):"horizvert"===e.orientation?(u.push({op:"L",x:o.x2,y:o.y1}),g.push({op:"L",x:100*(o.x2-n)/l,y:100*(o.y1-s)/d}),c>o.y1?(c-=t,f=a,x=c-t):(c+=t,f=a,x=c+t),h>o.x1?(v=r+t,y=h):(v=r-t,y=h)):(u.push({op:"L",x:p,y:o.y1}),u.push({op:"L",x:p,y:c}),g.push({op:"L",x:100*(p-n)/l,y:100*(o.y1-s)/d}),g.push({op:"L",x:100*(p-n)/l,y:100*(c-s)/d}),h>o.x1?(h-=t,v=r+t,y=h-t):(h+=t,v=r-t,y=h+t),f=a,x=c),u.push({op:"L",x:h,y:c}),g.push({op:"L",x:100*(h-n)/l,y:100*(c-s)/d}),this.param={alignmentRails:!1,noGridBlock:!0},this.components=[];var B={type:"path",origDim:{},dimension:{d:g},param:{fill:"none",stroke:"rgb(27,141,17)","stroke-miterlimit":"10","stroke-width":2,cursor:"hand","marker-end":"url(#fillArrowE)"},lines:u,properties:{"line-style":!0,"line-type":!0,"line-color":!0,"start-marker":!0,"end-marker":!0,"mid-marker":!0}};e.param&&(B.param=e.param),e.properties&&(B.properties=e.properties);var k=new ShapeComponent(B);this.components.push(k),this.properties=k.properties;var S=k.dom;S.onmouseover=function(){MagicBoard.indicators.mouseover.push(i)},S.onmouseout=function(){event.preventDefault();for(var e=MagicBoard.indicators.mouseover.length-1;e>-1;e--)if(MagicBoard.indicators.mouseover[e]===i)return void MagicBoard.indicators.mouseover.splice(e,1)},this.cx1=v,this.cx2=y,this.cy1=f,this.cy2=x,this.init(),e.shape=this,e.properties=k.properties,e.param=k.param};inheritsFrom(ConnectorLine,Shape),ConnectorLine.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage;e.appendChild(this.dom),e.innerHTML="";for(var t in this)"object"==typeof this[t]&&(this[t]=null)};var ShapeComponent=function(e){for(var t in e)this[t]=e[t];this.parentShape=null,this.dom=document.createElementNS("http://www.w3.org/2000/svg",this.type);for(var t in this.param)"border-radius"===t?(this.dom.setAttribute("rx",this.param[t]),this.dom.setAttribute("ry",this.param[t])):this.dom.setAttribute(t,this.param[t]);if(this.innerHTML&&(this.dom.innerHTML=this.innerHTML),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("transform","translate(1,1)"),this.derivedDimension={},!this.properties)switch(this.type){case"text":this.properties={"text-color":!0,"font-size":!0,"font-weight":!0,"text-content":!0};break;case"path":this.properties={"background-color":!0,"line-color":!0,"line-width":!0,"line-style":!0};break;default:this.properties={"background-color":!0,"border-color":!0,"border-width":!0,"border-style":!0}}};ShapeComponent.prototype.construct=function(){if(this.parentShape){var e=this.dom;this.calculateDimensions();for(var t in this.derivedDimension)this.dom.setAttribute(t,this.derivedDimension[t]);if("image"===this.type){var i=this.xlink;this.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",i)}return e}},ShapeComponent.prototype.calculateDimensions=function(){var e=0;this.param["stroke-width"]&&(e=parseInt(this.param["stroke-width"])),pw=this.parentShape.frame.width-2*e,ph=this.parentShape.frame.height-2*e;for(var t in this.dimension){var i="",o=this.dimension[t];switch(t){case"width":i=o*pw/100-2*e;break;case"x":case"x1":case"x2":case"cx":i=o*pw/100+e;break;case"rx":case"r":i=o*pw/100-e;break;case"height":i=o*ph/100-2*e;break;case"y":case"y1":case"y2":case"cy":i=o*ph/100+e;break;case"ry":i=o*ph/100-e;break;case"d":for(var r=o,a=r.length,n=0;a>n;n++){var s=r[n];if("Z"===s.op.toUpperCase()){i+=" Z ";break}for(var h in s)i+=h.indexOf("x")>-1?Math.round(s[h]*pw/100)+" ":h.indexOf("y")>-1?Math.round(s[h]*ph/100)+" ":s[h]+" "}}i&&(this.derivedDimension[t]=i)}if("text"===this.type||"rect"===this.type){if(this.dimension.cx){var c=parseInt(dom.getAttribute("cx"))-parseInt(dom.getAttribute("width"))/2;this.derivedDimension.x=c}if(this.dimension.cy){var l=parseInt(dom.getAttribute("cy"))-parseInt(dom.getAttribute("height"))/2;this.derivedDimension.y=l}}},ShapeComponent.prototype.drawOnCanvas=function(e){var t=this.parentShape.dimension.left,i=this.parentShape.dimension.top,o=this.derivedDimension.x+t,r=this.derivedDimension.y+i,a=this.param.fill;switch("none"===a&&(a=""),this.type){case"rect":a?e.fillRect(o,r,this.derivedDimension.width,this.derivedDimension.height):e.strokeRect(o,r,this.derivedDimension.width,this.derivedDimension.height);break;case"circle":break;case"eclipse":break;case"path":break;case"polyline":break;case"text":e.fillText(this.innerHTML,o,r)}},ShapeComponent.prototype.applyProperty=function(e,t,i){"attribute"===t?i?(this.dom.setAttribute(e,i),this.param[e]=i):(this.dom.removeAttribute(e),delete this.param[e]):"dom"===t&&(this.dom.innerHTML=i)},ShapeComponent.prototype.updateText=function(e){this.innerHTML=e,this.dom.innerHTML=e},document.addEventListener("dragstart",function(e){3===e.target.nodeType&&(e.preventDefault(),e.stopPropagation())},!1),MagicBoard.eventStart=function(e){MagicBoard.indicators.mouseDown=!0;var t=MagicBoard.getPos(e);MagicBoard.indicators.click=t;var i=MagicBoard.indicators.mouseover.length;if(!MagicBoard.indicators.hilight&&i>0){i--;for(var o=MagicBoard.indicators.mouseover[i];o.parentShape;)o=MagicBoard.indicators.mouseover[i--];o.parentShape&&(o=o.parentShape),MagicBoard.indicators.lineActive=o}MagicBoard.indicators.doubleClick++,setTimeout(function(){MagicBoard.indicators.doubleClick--},800)},MagicBoard.eventContinue=function(e){if(MagicBoard.indicators.mouseDown){var t=MagicBoard.indicators.click,i=null,o=MagicBoard.getPos(e);i=MagicBoard.indicators.hilight,i?MagicBoard.indicators.resize>-1?(i.resizeContinue(o,t),MagicBoard.indicators.resizeStarted=o):(MagicBoard.indicators.moveStarted=o,i.move(o,t)):(i=MagicBoard.indicators.lineActive,i&&i.lineTo(o))}},MagicBoard.eventStop=function(){if(MagicBoard.indicators.mouseDown=!1,MagicBoard.indicators.moveStarted){var e=MagicBoard.indicators.hilight,t=MagicBoard.indicators.moveStarted,i=MagicBoard.indicators.click,o=e.getDimension(),r=t.x-i.x,a=t.y-i.y,n=o.top+a,s=o.left+r;e.setPosition({x:s,y:n}),MagicBoard.indicators.moveStarted=null,e.selectToggle()}else{var h=MagicBoard.indicators.mouseover.length;if(h>0){h--;for(var c=MagicBoard.indicators.mouseover[h];c.parentShape;)c=MagicBoard.indicators.mouseover[h--];var l=MagicBoard.indicators.lineActive;if(MagicBoard.indicators.resize>-1){var e=MagicBoard.indicators.hilight;e.resizeStop()}else l&&l!==c&&l!==c.parentShape?l.connectTo(c):c.click()}else if(MagicBoard.indicators.lineActive){var d=MagicBoard.sheetBook.scratchCtx,p=MagicBoard.sheetBook.scratchCanvas;d.clearRect(0,0,p.width,p.height)}else MagicBoard.indicators.resize>-1&&(e=MagicBoard.indicators.hilight,e.resizeStop())}if(MagicBoard.indicators.lineActive=null,MagicBoard.indicators.click=null,MagicBoard.indicators.doubleClick>1){var h=MagicBoard.indicators.mouseover.length;if(h>0)for(var m=0;h>m;m++){var e=MagicBoard.indicators.mouseover[m];e.doubleClick()}}},MagicBoard.keyUp=function(e){var t=e.which;switch(e.ctrlKey?MagicBoard.indicators.keyType="ctrlKey":e.shiftKey&&(MagicBoard.indicators.keyType="shiftKey"),t){case 8:case 46:if(MagicBoard.indicators.hilight){var i=MagicBoard.indicators.hilight;i.click(),i.deleteShape()}case 90:case 122:"ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.sheetBook.currentSheet.undo();default:return}},MagicBoard.getPos=function(e){var t,i,o=0,r=0;return e.pageX||e.pageY?(t=e.pageX-document.body.scrollTop,i=e.pageY-document.body.scrollTop):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t-o-MagicBoard.boardPos.x,y:i-r-MagicBoard.boardPos.y}};var Utility={Shape:{},Sheet:{},SheetBook:{}};Utility.SheetBook.createWorkItems=function(e){e.connectCanvas=document.createElement("canvas"),e.connectCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),this.connectCtx=null,e.connectCanvas.setAttribute("name","workItem"),e.connectCanvas.height=e.cheight,e.connectCanvas.width=e.cwidth,e.connectCtx=e.connectCanvas.getContext("2d"),e.connectCtx.translate(.5,.5),e.scratchCanvas=document.createElement("canvas"),e.scratchCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),e.scratchCtx=null,e.scratchCanvas.setAttribute("name","workItem"),e.scratchCanvas.height=e.cheight,e.scratchCanvas.width=e.cwidth,e.scratchCtx=e.scratchCanvas.getContext("2d"),e.scratchCtx.translate(.5,.5),e.hilighter=document.createElement("div"),e.hilighter.setAttribute("style","visibility:hidden;height:100px;width:100px;left:0px;top:0px;z-index:10"),e.hilighter.setAttribute("class","hilight"),e.hilighter.onmouseover=function(){MagicBoard.indicators.hilight&&MagicBoard.indicators.mouseover.push(MagicBoard.indicators.hilight)},e.hilighter.onmouseout=function(){event.preventDefault(),MagicBoard.indicators.mouseover=[]},e.hilighter.innerHTML="<div class='stretcher'><div class='red'></div></div><div class='stretcher'><div class='red'></div></div><div class='stretcher'><div class='red'></div></div><div class='stretcher'><div class='red'></div></div><div class='clickPrompt' onclick='Utility.Shape.showProperty()'></div>";var t=e.hilighter.children,i=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=-1)};t[0].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=0)},t[0].onmouseout=i,t[1].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=1)},t[1].onmouseout=i,t[2].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=2)},t[2].onmouseout=i,t[3].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=3)},t[3].onmouseout=i,e.textEditor=document.createElement("div"),e.textEditor.setAttribute("contenteditable","true"),e.textEditor.setAttribute("style","position:absolute;left:0px;top:0px;width:10px;height:14px;display:none;background:white;z-index:100"),document.body.appendChild(e.textEditor),e.textEditor.onblur=function(){e.textEditor.style.display="none";var t=e.textEditor.targetShape;t.updateText(e.textEditor.innerHTML),t.selectToggle(),e.textEditor.targetShape=null},Utility.SheetBook.attachWorkItems(e)},Utility.SheetBook.attachWorkItems=function(e){sheetCanvas=e.anchor,sheetCanvas.appendChild(e.scratchCanvas),sheetCanvas.appendChild(e.connectCanvas),sheetCanvas.appendChild(e.hilighter)},Utility.SheetBook.activateHilighter=function(e){var t=e.left-4,i=e.top-4,o=e.width+8,r=e.height+8,a=MagicBoard.sheetBook.hilighter;a.style.visibility="visible",a.style.left=t+"px",a.style.top=i+"px",a.style.width=o+"px",a.style.height=r+"px";
var n=a.children,s=n[0].style;s.left="-12px",s.top=r/2-12+"px",s.cursor="ew-resize";var h=n[1].style;h.left=o-14+"px",h.top=r/2-12+"px",h.cursor="ew-resize";var c=n[2].style;c.left=o/2-12+"px",c.top="-12px",c.cursor="ns-resize";var l=n[3].style;l.left=o/2-12+"px",l.top=r-14+"px",l.cursor="ns-resize"},Utility.Sheet.Markers=function(e){var t="<defs><marker id='fillArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='rgb(27,141,17)'></path></marker><marker id='fillArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='rgb(27,141,17)'></path></marker><marker id='hollowArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='fillDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='rgb(27,141,17)' ></path></marker><marker id='dot' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><circle r='3' cx='3' cy='3' fill='rgb(27,141,17)' ></circle></marker><marker id='lineArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L9,3 L0,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='lineArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M9,0 L0,3 L9,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker></defs>";e.canvas.innerHTML=t},Utility.Sheet.isGridAvailable=function(e,t,i){var o=i.dimension,r=t.courseGrids,a=r.length,n=t.noOfXcourseGrids,s=(t.noOfYcourseGrids,10),h=MagicBoard.sheetBook.cwidth,c=MagicBoard.sheetBook.cheight;if(-1===e){var l=0,d=0;o.left&&(l=o.left),e=Utility.Sheet.LeftAlignedFreeGrid(l,d,t);for(var p=e;a>p;p++){var m=r[p];if(!m.filled)return Utility.Sheet.isGridAvailable(p,t,i)}}var u=r[e],g=u.x1+s,v=u.y1+s,y={x:g,y:v},f={x:g+o.width,y:v};if(f.x>h)return Utility.Sheet.isGridAvailable(e+1,t,i);var x={x:g,y:v+o.height};if(x.y>c)return[];for(var B=({x:g+o.width,y:v+o.height},Math.floor(e/n)+1,[]),k=e;a>k;k++){var S,b,M,w,m=r[k];if(S=m.x1,b=m.x2,M=m.y1,w=m.y2,!(b<y.x||S>f.x)){if(M>x.y)break;if(!(w<y.y)){if(m.filled){for(var C=k;a>C;C++){if(C>=a)return[];if(!r[C].filled)break}var T=Utility.Sheet.isGridAvailable(C,t,i);if(T.length>0)return T}B.push(k)}}}return B},Utility.Sheet.LeftAlignedFreeGrid=function(e,t,i){var o=i.noOfXcourseGrids,r=i.courseGrids;return startGridSeq=Math.floor(t/i.courseGridSize.y)*o+Math.floor(e/i.courseGridSize.x),startGridSeq>r.length?0:r[startGridSeq].filled?e?Utility.Sheet.LeftAlignedFreeGrid(e,t+i.courseGridSize.y,i):startGridSeq++:startGridSeq},Utility.Sheet.findOwner=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,o=0;i>o;o++){var r=t.shapes[o];if(r.dom===e)return r.dom;for(var a=r.components.length,n=0;a>n;n++){var s=r.components[n];if(s.dom===e)return s}}return null},Utility.Shape.applyProperty=function(){var e=document.getElementById("propPrompt"),t=e.shape;e.shape=null;for(var i=e.getElementsByClassName("prop"),o=i.length,r=0;o>r;r++){var a=i[r],n=a.getAttribute("data-dirty");if(n&&"1"===n){var s,h=a.getAttribute("data-propKey"),c=a.getAttribute("data-propType"),l=a.getAttribute("data-propName");"INPUT"===a.nodeName?s=a.value:"SELECT"===a.nodeName&&(s=a.options[a.selectedIndex].value),t.applyProperty(h,l,c,s)}}Utility.destroyDom(e,"dom")},Utility.addChangeFlag=function(){var e=event.target;e.setAttribute("data-dirty","1")},Utility.Shape.showProperty=function(){{var e="",t=MagicBoard.indicators.hilight,i=t.properties;i.length}for(var o in i){var r=MagicBoard.properties[o];if("input"===r.field)e+="<label class='propLabel'>"+r.label+":</label><input class='propInput prop' data-propKey='"+o+"' class='prop' data-propType='"+r.propType+"'  data-propName='"+r.propName+"' type='"+r.values[0].type+"' value='"+r.values[0].value+"' onchange='Utility.addChangeFlag()'/><BR/>";else if("select"===r.field){e+="<label class='propLabel' >"+r.label+":</label><select onchange='Utility.addChangeFlag()' data-propKey='"+o+"' class='prop' data-propType='"+r.propType+"'  data-propName='"+r.propName+"'  >";for(var a=0,n=r.values.length;n>a;a++)e+="<option value='"+r.values[a].value+"' >"+r.values[a].name+"</option>";e+="</select><BR/>"}}if(e){e+="<br/><button class='apply button' onclick='Utility.Shape.applyProperty()'>Apply</button><button class='cancel button' onclick='Utility.destroyDom(\"propPrompt\",\"id\")'>Cancel</button>";var s=document.createElement("div");s.setAttribute("class","prompt"),s.setAttribute("style",""),s.setAttribute("id","propPrompt"),s.innerHTML=e,s.shape=t,document.body.appendChild(s)}},Utility.Shape.align=function(e){var t=MagicBoard.sheetBook.alignments.x,i=MagicBoard.sheetBook.alignments.y,o=9999,r=9999,a=e.x;nearestY=e.y;for(var n in t)if(t[n]&&t[n].length>0){var s=Math.abs(e.y-n);r>s&&(r=s,nearestY=n)}for(var h in i)if(i[h]&&i[h].length>0){var s=Math.abs(e.x-h);o>s&&(o=s,a=h)}return Math.abs(e.x-a)<20&&("string"==typeof a&&(a=parseInt(a)),e.x=a),Math.abs(e.y-nearestY)<20&&("string"==typeof nearestY&&(nearestY=parseInt(nearestY)),e.y=nearestY),e},Utility.Sheet.drawCourseGrid=function(e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height),t.setLineDash([1,15]),t.beginPath();for(var o=0,r=0;r<e.noOfYcourseGrids;r++){var a=r*e.courseGridSize.y;t.moveTo(0,a),t.lineTo(MagicBoard.sheetBook.cwidth,a);for(var n=0;n<e.noOfXcourseGrids;n++){var s=n*e.courseGridSize.x;t.moveTo(s,0),t.lineTo(s,MagicBoard.sheetBook.cheight);var h="Filled "+o,c=e.courseGrids[o++];c.filled&&t.fillText(h,s+20,a+20)}}t.stroke()},Utility.Shape.blockGrids=function(e){var t=e.currentSheet,i=e.dimension,o=t.courseGrids;Utility.Shape.unblockGrids(e,o);for(var r=i.left,a=i.top,n=Math.floor(r/t.courseGridSize.x),s=Math.floor(a/t.courseGridSize.y),h=s*t.noOfXcourseGrids+n,c={x:r,y:a},l={x:r+i.width,y:a},d={x:r,y:a+i.height},o=({x:r+i.width,y:a+i.height},t.courseGrids),p=o.length,m=h;p>m;m++){var u,g,v,y,f=o[m];if(u=f.x1,g=f.x2,v=f.y1,y=f.y2,!(g<c.x||u>l.x)){if(v>d.y)break;y<c.y||(f.filled=!0,f.shapes.push(e),e.occupiedGrids.push(m))}}},Utility.Shape.unblockGrids=function(e,t){for(var i=e.occupiedGrids,o=i.length,r=0;o>r;r++){for(var a=i[r],n=t[a],s=n.shapes,h=s.length,c=0;h>c;c++){var l=s[c];if(l===e){s.splice(c,1);break}}0===s.length&&(n.filled=!1)}e.occupiedGrids=[]},Utility.Shape.calculateConnectionPoints=function(e,t){var i,o,r,a,n=e.getDimension(),s=t.getDimension(),h=n.edgePoints,c=s.edgePoints,l="horiz";if(h.c1.x>c.c2.x){var d=h.m41.x-c.m23.x;if(d>50)i=h.m41.x,r=h.m41.y,o=c.m23.x,a=c.m23.y;else{var p=h.m41.y-c.m23.y,m=(h.m12.x-c.m23.x,h.m12.y-c.m23.y),u=(h.m12.x-c.m23.x,h.m12.y-c.m23.y);if(m>50)h.m12.x-c.m34.x>50?(i=h.m12.x,r=h.m12.y,o=c.m34.x,a=c.m34.y,l="vert"):(i=h.m12.x,r=h.m12.y,o=c.m23.x,a=c.m23.y,l="horizvert");else if(u>50)i=h.m34.x,r=h.m34.y,o=c.m23.x,a=c.m23.y,l="horizvert";else if(p>50){var g=h.m41.y-c.m34.y;g>50?(i=h.m41.x,r=h.m41.y,o=c.m34.x,a=c.m34.y):(i=h.m41.x,r=h.m41.y,o=c.m23.x,a=c.m23.y)}else i=h.m41.x,r=h.m41.y,o=c.m23.x,a=c.m23.y}}else if(h.c2.x<c.c1.x){var v=h.m41.x-c.m23.x;if(v>50)i=h.m23.x,r=h.m23.y,o=c.m41.x,a=c.m41.y;else{var y=(h.m23.y-c.m41.y,h.m23.x-c.m12.x,h.m23.y-c.m12.y),f=(h.m23.x-c.m34.x,h.m23.y-c.m34.y);Math.abs(f)>50?(i=h.m23.x,r=h.m23.y,f>0?(o=c.m34.x,a=c.m34.y):(o=c.m12.x,a=c.m12.y),l="horizvert"):y>50?c.m41.x-h.m23.x>50?(i=h.m23.x,r=h.m23.y,o=c.m41.x,a=c.m41.y):(i=h.m23.x,r=h.m23.y,o=c.m12.x,a=c.m12.y,l="horizvert"):(i=h.m23.x,r=h.m23.y,o=c.m41.x,a=c.m41.y)}}else h.c1.y>c.c3.y?(i=h.m12.x,r=h.m12.y,o=c.m34.x,a=c.m34.y,l="vert"):(i=h.m34.x,r=h.m34.y,o=c.m12.x,a=c.m12.y,l="vert");return{beginShape:e,endShape:t,pos:{x1:i,x2:o,y1:r,y2:a},orientation:l}},Utility.Sheet.removeConnection=function(e,t,i){for(var o=e.connections,r=o.length,a=0;r>a;a++){var n=o[a];if(n.beginShape===t&&n.endShape===i)return void o.splice(a,1)}},Utility.Shape.dataFormatter=function(e,t,i){if(void 0==e)return 0;if("number"==typeof e)return e;if("string"==typeof e){if(e.indexOf("px")>-1)return parseInt(e.replace("px",""));if(e.indexOf("%")>-1){if(!i)return console.log(" In order to calculate %, we need the shape, that is missing in the call"),0;var o=parseInt(e.replace("%","")),r=null;if(i.parentShape)r=i.parentShape.dimension;else{var a=MagicBoard.sheetBook;r={left:0,top:0,width:a.cwidth,height:a.cheight}}var n=t;return"left"===t?n="width":"top"===t&&(n="height"),r[n]*o/100}}},Utility.Shape.recalculateDimensions=function(e){var t=e.dimension;if(t.misc.unit&&"%"===t.misc.unit)for(var i=t.misc.key,o=i.length,r=0;o>r;r++){var a=i[r],n=e.style[a],s=Utility.Shape.dataFormatter(n,a,e);t[a]=s}},Utility.destroyDom=function(e,t){var i=MagicBoard.sheetBook.garbage,o=null;"id"===t?o=document.getElementById(e):"dom"===t&&(o=e),i.appendChild(o),i.innerHTML=""};var Logger=function(){},Info=function(){};inheritsFrom(Info,Logger),Info.prototype.console=function(e){console.log("Info - "+e)};var Warning=function(){};inheritsFrom(Warning,Logger),Warning.prototype.console=function(e){console.log("Warning - "+e)};var Error=function(){};inheritsFrom(Error,Logger),Error.prototype.console=function(e){Error.log("Error - "+e)};var info=new Info,warning=new Warning,error=new Error;